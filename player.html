<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
  <title>BTF TV ‚Äì Player</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome 6 (free) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      position: fixed;
      inset: 0;
    }
    /* main container ‚Äì full screen */
    #player {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
    }
    /* video wrapper takes all available space */
    .video-wrapper {
      flex: 1;
      position: relative;
      background: #000;
      overflow: hidden;
      touch-action: pan-y pinch-zoom; /* allow vertical swipe if needed, but we'll use taps */
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none; /* blocks native controls, we handle gestures via overlay */
    }
    /* transparent overlay for gestures */
    .gesture-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      z-index: 10;
    }
    .gesture-left, .gesture-right {
      flex: 1;
      height: 100%;
    }
    /* top bar (back, title, etc) */
    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 16px 16px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
      z-index: 20;
      pointer-events: none; /* allow clicks to pass through except back button */
    }
    .top-bar * {
      pointer-events: auto;
    }
    .back-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      color: white;
      cursor: pointer;
      flex-shrink: 0;
    }
    .back-btn:active {
      background: #FFD700;
      color: black;
    }
    .show-title {
      font-family: 'Bebas Neue', cursive;
      font-size: 1.4rem;
      letter-spacing: 1px;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* bottom info & episode strip */
    .bottom-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px 16px 30px;
      background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
      z-index: 20;
      pointer-events: none;
    }
    .bottom-panel * {
      pointer-events: auto;
    }
    .episode-info {
      margin-bottom: 16px;
    }
    .episode-title {
      font-family: 'Bebas Neue', cursive;
      font-size: 2rem;
      line-height: 1.2;
      color: #FFD700;
    }
    .episode-meta {
      font-size: 0.8rem;
      color: #ccc;
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .episode-desc {
      font-size: 0.85rem;
      color: #ddd;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-top: 6px;
      max-width: 90%;
    }
    /* episode strip (horizontal scroll) */
    .ep-strip {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      scrollbar-width: none;
      padding: 8px 0 4px;
      -webkit-overflow-scrolling: touch;
    }
    .ep-strip::-webkit-scrollbar {
      display: none;
    }
    .ep-pill {
      min-width: 44px;
      height: 44px;
      border-radius: 30px;
      background: rgba(34,34,34,0.8);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      color: white;
      transition: all 0.15s;
      padding: 0 16px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .ep-pill.active {
      background: #FFD700;
      color: #000;
      border-color: #FFD700;
    }
    .ep-pill.locked {
      opacity: 0.6;
      background: rgba(0,0,0,0.5);
      color: #aaa;
    }
    .ep-pill.locked::after {
      content: '\f023';  /* lock icon */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-left: 6px;
      font-size: 0.8rem;
    }
    /* next episode overlay */
    .next-overlay {
      position: absolute;
      bottom: 120px;
      left: 16px;
      right: 16px;
      background: rgba(20,20,20,0.95);
      backdrop-filter: blur(12px);
      border-radius: 40px;
      padding: 16px 24px;
      border: 1px solid rgba(255,215,0,0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 30;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    .next-overlay.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }
    .next-info {
      display: flex;
      flex-direction: column;
    }
    .next-label {
      font-size: 0.7rem;
      color: #FFD700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .next-title {
      font-weight: 600;
      font-size: 1rem;
    }
    .next-actions {
      display: flex;
      gap: 16px;
    }
    .next-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 8px;
    }
    .next-btn:active {
      color: #FFD700;
    }
    /* center play/pause (shows briefly) */
    .center-play {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      background: rgba(255,215,0,0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #000;
      z-index: 15;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }
    .center-play.visible {
      opacity: 1;
    }
    /* loading spinner */
    #spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top-color: #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 25;
      display: none;
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    #spinner.show { display: block; }
    /* toast */
    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #1a1a1a;
      color: white;
      border: 1px solid #333;
      padding: 10px 20px;
      border-radius: 40px;
      font-size: 0.85rem;
      font-weight: 600;
      z-index: 999;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
      white-space: nowrap;
    }
    #toast.on { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <div id="player">
    <div class="video-wrapper">
      <video id="video" playsinline preload="metadata" disablepictureinpicture></video>
      <!-- gesture overlay -->
      <div class="gesture-overlay">
        <div class="gesture-left" id="tap-left"></div>
        <div class="gesture-right" id="tap-right"></div>
      </div>
      <!-- top bar -->
      <div class="top-bar">
        <button class="back-btn" id="back-btn"><i class="fas fa-arrow-left"></i></button>
        <div class="show-title" id="show-title">Loading...</div>
      </div>
      <!-- bottom panel -->
      <div class="bottom-panel">
        <div class="episode-info">
          <div class="episode-title" id="ep-title"></div>
          <div class="episode-meta" id="ep-meta"></div>
          <div class="episode-desc" id="ep-desc"></div>
        </div>
        <!-- horizontal episode strip -->
        <div class="ep-strip" id="ep-strip"></div>
      </div>
      <!-- next episode overlay -->
      <div class="next-overlay" id="nextOverlay">
        <div class="next-info">
          <span class="next-label">‡§Ö‡§ó‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§°</span>
          <span class="next-title" id="next-title">Ep 2: Title</span>
        </div>
        <div class="next-actions">
          <button class="next-btn" id="next-cancel"><i class="fas fa-times"></i></button>
          <button class="next-btn" id="next-go"><i class="fas fa-step-forward"></i></button>
        </div>
      </div>
      <!-- center play/pause indicator -->
      <div class="center-play" id="centerPlay"><i class="fas fa-play"></i></div>
      <!-- spinner -->
      <div id="spinner"></div>
    </div>
  </div>
  <div id="toast"></div>

  <script>
    (function() {
      'use strict';

      // ---------- SECURITY ----------
      document.addEventListener('contextmenu', e => e.preventDefault(), true);
      document.addEventListener('keydown', e => {
        const k = e.key.toLowerCase();
        if ((e.ctrlKey || e.metaKey) && ['s','u','a','c','j','i','p'].includes(k)) {
          e.preventDefault();
          e.stopPropagation();
        }
        if (e.key === 'F12' || e.key === 'PrintScreen') e.preventDefault();
      }, true);
      document.addEventListener('dragstart', e => e.preventDefault(), true);
      document.addEventListener('drop', e => e.preventDefault(), true);
      document.addEventListener('selectstart', e => e.preventDefault(), true);
      document.addEventListener('touchstart', e => {
        if (e.target.tagName === 'VIDEO') e.preventDefault();
      }, { passive: false });
      document.addEventListener('enterpictureinpicture', e => e.preventDefault(), true);

      // ---------- GLOBALS ----------
      let D = null;                // full data
      let show = null;             // current show
      let currentEpIndex = 0;      // 0-based
      let autoNextTimer = null;
      let hideControlsTimer = null;
      const video = document.getElementById('video');
      const epStrip = document.getElementById('ep-strip');
      const nextOverlay = document.getElementById('nextOverlay');
      const nextTitle = document.getElementById('next-title');
      const spinner = document.getElementById('spinner');
      const centerPlay = document.getElementById('centerPlay');
      const toast = document.getElementById('toast');
      
      const params = new URLSearchParams(location.search);
      const sid = params.get('sid');
      const ei = parseInt(params.get('ei') || '0', 10);
      currentEpIndex = ei;

      // history object for progress
      let historyData = JSON.parse(localStorage.getItem('btftv_h') || '{}');

      // ---------- UTILS ----------
      function fmtTime(seconds) {
        if (!seconds || isNaN(seconds)) return '0:00';
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return m + ':' + (s < 10 ? '0' : '') + s;
      }

      function toastMsg(msg) {
        toast.textContent = msg;
        toast.classList.add('on');
        setTimeout(() => toast.classList.remove('on'), 2500);
      }

      // ---------- DATA LOAD ----------
      async function loadData() {
        try {
          const res = await fetch('https://storytv.btfcompanystorage.workers.dev/data');
          if (!res.ok) throw new Error('Network error');
          D = await res.json();
        } catch (e) {
          toastMsg('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü');
          return;
        }
        show = D.shows.find(s => s.id === sid);
        if (!show) {
          toastMsg('‡§∂‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ');
          return;
        }
        // set favicon
        if (D.site?.favicon_url) {
          let link = document.querySelector("link[rel='icon']") || document.createElement('link');
          link.rel = 'icon';
          link.href = D.site.favicon_url;
          document.head.appendChild(link);
        }
        document.getElementById('show-title').textContent = show.title || 'Show';
        renderEpisode(currentEpIndex);
        renderEpisodeStrip();
      }

      // ---------- RENDER EPISODE ----------
      function renderEpisode(index) {
        const ep = show.episodes[index];
        if (!ep) return;

        // update url (without reload)
        const newUrl = location.pathname + '?sid=' + sid + '&ei=' + index;
        history.replaceState(null, '', newUrl);

        // update top and bottom info
        document.getElementById('ep-title').textContent = ep.title || `‡§è‡§™‡§ø‡§∏‡•ã‡§° ${ep.ep}`;
        document.getElementById('ep-meta').innerHTML = `Ep ${ep.ep} ¬∑ ${ep.duration} ¬∑ ${show.language}`;
        document.getElementById('ep-desc').textContent = ep.description || '';
        document.title = `Ep ${ep.ep} ‚Äì ${show.title} | BTF TV`;

        // load video securely
        loadVideoSecure(ep.video_url, index);

        // mark active pill
        document.querySelectorAll('.ep-pill').forEach((pill, i) => {
          if (i === index) pill.classList.add('active');
          else pill.classList.remove('active');
        });

        // restore progress if any
        const key = sid + '_' + index;
        const saved = historyData[key]?.t || 0;
        if (saved > 3) {
          const onCanPlay = () => {
            video.currentTime = saved;
            video.removeEventListener('canplay', onCanPlay);
          };
          video.addEventListener('canplay', onCanPlay);
        }

        // hide next overlay
        hideNextOverlay();
      }

      // secure video loading (blob)
      async function loadVideoSecure(url, idx) {
        spinner.classList.add('show');
        video.src = '';
        if (window.blobUrl) {
          URL.revokeObjectURL(window.blobUrl);
          window.blobUrl = null;
        }
        try {
          const resp = await fetch(url, { mode: 'cors' });
          if (!resp.ok) throw new Error();
          const blob = await resp.blob();
          window.blobUrl = URL.createObjectURL(blob);
          video.src = window.blobUrl;
          video.load();
          // attempt autoplay
          video.play().catch(() => {
            // autoplay may be blocked; show play button briefly
            centerPlay.classList.add('visible');
            setTimeout(() => centerPlay.classList.remove('visible'), 1000);
          });
        } catch (e) {
          toastMsg('‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü, ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...');
          video.src = url;  // fallback to direct url
          video.load();
          video.play().catch(() => {});
        } finally {
          spinner.classList.remove('show');
        }
      }

      // ---------- EPISODE STRIP ----------
      function renderEpisodeStrip() {
        const episodes = show.episodes;
        let html = '';
        episodes.forEach((ep, i) => {
          const isFree = ep.is_free === true;
          const activeClass = (i === currentEpIndex) ? 'active' : '';
          const lockClass = isFree ? '' : 'locked';
          html += `<div class="ep-pill ${activeClass} ${lockClass}" data-index="${i}">${ep.ep}</div>`;
        });
        epStrip.innerHTML = html;

        // attach click listeners
        document.querySelectorAll('.ep-pill').forEach(pill => {
          pill.addEventListener('click', (e) => {
            const idx = parseInt(pill.dataset.index, 10);
            if (idx === currentEpIndex) return;
            const ep = show.episodes[idx];
            if (!ep.is_free) {
              toastMsg('üîí ‡§Ø‡§π ‡§è‡§™‡§ø‡§∏‡•ã‡§° GOLD ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨‡§∞‡•ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à');
              return;
            }
            // cancel any pending auto next
            if (autoNextTimer) clearTimeout(autoNextTimer);
            hideNextOverlay();
            currentEpIndex = idx;
            renderEpisode(idx);
          });
        });
      }

      // ---------- GESTURE HANDLING (tap left/right) ----------
      document.getElementById('tap-left').addEventListener('click', () => {
        // previous episode
        if (currentEpIndex > 0) {
          const prevEp = show.episodes[currentEpIndex - 1];
          if (!prevEp.is_free) {
            toastMsg('üîí ‡§™‡§ø‡§õ‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§° GOLD ‡§π‡•à');
            return;
          }
          currentEpIndex--;
          renderEpisode(currentEpIndex);
        } else {
          toastMsg('‡§Ø‡§π ‡§™‡§π‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§° ‡§π‡•à');
        }
      });

      document.getElementById('tap-right').addEventListener('click', () => {
        // next episode
        if (currentEpIndex < show.episodes.length - 1) {
          const nextEp = show.episodes[currentEpIndex + 1];
          if (!nextEp.is_free) {
            toastMsg('üîí ‡§Ö‡§ó‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§° GOLD ‡§π‡•à');
            return;
          }
          currentEpIndex++;
          renderEpisode(currentEpIndex);
        } else {
          toastMsg('‡§Ø‡§π ‡§Ü‡§ñ‡§ø‡§∞‡•Ä ‡§è‡§™‡§ø‡§∏‡•ã‡§° ‡§π‡•à');
        }
      });

      // double tap for +/- 10s (optional, but we keep simple)
      let lastTap = 0;
      document.querySelector('.video-wrapper').addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTap < 300) {
          // double tap: skip based on side
          const touch = e.changedTouches[0];
          const half = window.innerWidth / 2;
          if (touch.clientX < half) {
            // skip back 10
            video.currentTime = Math.max(0, video.currentTime - 10);
            showFlash('left');
          } else {
            video.currentTime = Math.min(video.duration || 0, video.currentTime + 10);
            showFlash('right');
          }
        }
        lastTap = now;
      });

      function showFlash(side) {
        // simple visual feedback (can be enhanced)
        centerPlay.innerHTML = side === 'left' ? '<i class="fas fa-backward"></i>' : '<i class="fas fa-forward"></i>';
        centerPlay.classList.add('visible');
        setTimeout(() => centerPlay.classList.remove('visible'), 300);
      }

      // single tap to show/hide controls (already visible, but we can toggle auto-hide)
      let controlsVisible = true;
      document.querySelector('.video-wrapper').addEventListener('click', (e) => {
        // ignore if clicking on buttons or ep-strip
        if (e.target.closest('button') || e.target.closest('.ep-pill')) return;
        // toggle top/bottom bars
        const topBar = document.querySelector('.top-bar');
        const bottomPanel = document.querySelector('.bottom-panel');
        if (controlsVisible) {
          topBar.style.opacity = '0';
          bottomPanel.style.opacity = '0';
        } else {
          topBar.style.opacity = '1';
          bottomPanel.style.opacity = '1';
          // auto hide after 3s
          if (hideControlsTimer) clearTimeout(hideControlsTimer);
          hideControlsTimer = setTimeout(() => {
            if (!video.paused) {
              topBar.style.opacity = '0';
              bottomPanel.style.opacity = '0';
              controlsVisible = false;
            }
          }, 3000);
        }
        controlsVisible = !controlsVisible;
      });

      // video events
      video.addEventListener('play', () => {
        centerPlay.innerHTML = '<i class="fas fa-pause"></i>';
        centerPlay.classList.add('visible');
        setTimeout(() => centerPlay.classList.remove('visible'), 600);
        // hide controls after a while
        if (hideControlsTimer) clearTimeout(hideControlsTimer);
        hideControlsTimer = setTimeout(() => {
          document.querySelector('.top-bar').style.opacity = '0';
          document.querySelector('.bottom-panel').style.opacity = '0';
          controlsVisible = false;
        }, 3000);
      });

      video.addEventListener('pause', () => {
        centerPlay.innerHTML = '<i class="fas fa-play"></i>';
        centerPlay.classList.add('visible');
        // show controls when paused
        document.querySelector('.top-bar').style.opacity = '1';
        document.querySelector('.bottom-panel').style.opacity = '1';
        controlsVisible = true;
        if (hideControlsTimer) clearTimeout(hideControlsTimer);
      });

      video.addEventListener('waiting', () => spinner.classList.add('show'));
      video.addEventListener('canplay', () => spinner.classList.remove('show'));
      video.addEventListener('ended', () => {
        // show next episode overlay if available
        if (currentEpIndex < show.episodes.length - 1) {
          const nextEp = show.episodes[currentEpIndex + 1];
          nextTitle.textContent = `Ep ${nextEp.ep}: ${nextEp.title}`;
          nextOverlay.classList.add('show');
          // auto-go after 5 seconds
          autoNextTimer = setTimeout(() => {
            if (nextEp.is_free) {
              currentEpIndex++;
              renderEpisode(currentEpIndex);
            } else {
              toastMsg('üîí ‡§Ö‡§ó‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§° GOLD ‡§π‡•à');
              hideNextOverlay();
            }
          }, 5000);
        } else {
          // no next episode
          toastMsg('‡§∏‡§≠‡•Ä ‡§è‡§™‡§ø‡§∏‡•ã‡§° ‡§¶‡•á‡§ñ ‡§≤‡§ø‡§è ‡§ó‡§è');
        }
      });

      // next overlay buttons
      document.getElementById('next-cancel').addEventListener('click', () => {
        hideNextOverlay();
        if (autoNextTimer) clearTimeout(autoNextTimer);
      });
      document.getElementById('next-go').addEventListener('click', () => {
        if (autoNextTimer) clearTimeout(autoNextTimer);
        if (currentEpIndex < show.episodes.length - 1) {
          const nextEp = show.episodes[currentEpIndex + 1];
          if (!nextEp.is_free) {
            toastMsg('üîí GOLD ‡§ö‡§æ‡§π‡§ø‡§è');
            hideNextOverlay();
            return;
          }
          currentEpIndex++;
          renderEpisode(currentEpIndex);
        }
      });

      function hideNextOverlay() {
        nextOverlay.classList.remove('show');
        if (autoNextTimer) clearTimeout(autoNextTimer);
      }

      // progress save
      video.addEventListener('timeupdate', () => {
        if (!video.duration) return;
        const key = sid + '_' + currentEpIndex;
        historyData[key] = {
          sid, ei: currentEpIndex,
          t: Math.round(video.currentTime),
          d: Math.round(video.duration)
        };
        try { localStorage.setItem('btftv_h', JSON.stringify(historyData)); } catch (e) {}
      });

      // back button
      document.getElementById('back-btn').addEventListener('click', () => {
        if (window.blobUrl) URL.revokeObjectURL(window.blobUrl);
        history.back();
      });

      // fullscreen handling (optional: we are already full-viewport, but we can allow native fullscreen)
      // we'll keep it simple

      // start
      loadData();
    })();
  </script>
</body>
</html>
