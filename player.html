<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>BTF TV ‚Äì Reels Player</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    *, *::before, *::after {
      margin: 0; padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    :root {
      --gold: #FFD700;
      --gold-dim: rgba(255,215,0,0.3);
      --dark: rgba(10,10,10,0.96);
      --bar-grad-top: linear-gradient(to bottom, rgba(0,0,0,0.75) 0%, transparent 100%);
      --bar-grad-bot: linear-gradient(to top, rgba(0,0,0,0.85) 0%, transparent 100%);
      --transition-speed: 0.35s;
    }

    html, body {
      height: 100%; width: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Poppins', sans-serif;
      color: white;
    }

    /* ======== VIEWPORT / REEL STACK ======== */
    #reels-viewport {
      position: fixed;
      inset: 0;
      overflow: hidden;
      background: #000;
    }

    /* The sliding container holding all episode wrappers */
    #reels-track {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      /* height set by JS = episodes * 100% */
      will-change: transform;
      transition: transform var(--transition-speed) cubic-bezier(0.25,0.46,0.45,0.94);
    }
    #reels-track.instant {
      transition: none !important;
    }

    /* Each episode slide */
    .reel-slide {
      position: relative;
      width: 100%;
      height: 100vh;
      background: #000;
      overflow: hidden;
    }

    .reel-slide video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
      background: #000;
      display: block;
    }

    /* ======== TOP BAR ======== */
    .top-bar {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: env(safe-area-inset-top, 16px) 16px 16px;
      padding-top: max(env(safe-area-inset-top), 16px);
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bar-grad-top);
      z-index: 20;
      transition: opacity 0.25s, visibility 0.25s;
    }
    .top-bar.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

    .icon-btn {
      width: 42px; height: 42px;
      border-radius: 50%;
      background: rgba(30,30,30,0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.15);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; color: white;
      cursor: pointer; flex-shrink: 0;
      transition: background 0.15s, color 0.15s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }
    .icon-btn:active { background: var(--gold); color: #000; transform: scale(0.92); }

    .show-title {
      font-family: 'Bebas Neue', cursive;
      font-size: 1.4rem;
      text-shadow: 0 2px 8px rgba(0,0,0,0.8);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      letter-spacing: 1px;
    }

    .playlist-btn {
      color: var(--gold);
      border-color: var(--gold-dim);
      margin-left: auto;
    }

    /* ======== BOTTOM BAR ======== */
    .bottom-bar {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      padding: 20px 16px;
      padding-bottom: max(env(safe-area-inset-bottom), 24px);
      background: var(--bar-grad-bot);
      z-index: 20;
      transition: opacity 0.25s, visibility 0.25s;
    }
    .bottom-bar.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

    .episode-info { margin-bottom: 14px; }

    .episode-title {
      font-family: 'Bebas Neue', cursive;
      font-size: 1.9rem;
      color: var(--gold);
      line-height: 1.1;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.7);
    }

    .episode-meta {
      font-size: 0.72rem;
      color: #bbb;
      display: flex;
      gap: 8px;
      margin-top: 4px;
      align-items: center;
    }
    .episode-meta span {
      display: flex; align-items: center; gap: 4px;
    }

    /* playback controls row */
    .controls-row {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 10px;
    }

    .play-pause-btn {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: var(--gold);
      border: none;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem;
      color: #000;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.1s, background 0.15s;
      box-shadow: 0 4px 16px rgba(255,215,0,0.4);
    }
    .play-pause-btn:active { transform: scale(0.9); }

    .vol-btn {
      font-size: 1.1rem;
      color: rgba(255,255,255,0.8);
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
    }

    .ep-counter {
      font-size: 0.72rem;
      color: #bbb;
      margin-left: auto;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* ======== PROGRESS BAR ======== */
    .progress-container {
      width: 100%;
      height: 28px;
      display: flex;
      align-items: center;
      cursor: pointer;
      touch-action: none;
    }

    .progress-track {
      flex: 1;
      height: 3px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      position: relative;
      transition: height 0.15s;
    }
    .progress-container:active .progress-track { height: 5px; }

    .progress-fill {
      height: 100%;
      background: var(--gold);
      border-radius: 4px;
      width: 0%;
      pointer-events: none;
      transition: width 0.1s linear;
    }

    .progress-handle {
      width: 14px; height: 14px;
      background: var(--gold);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 0%;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.15s;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(255,215,0,0.5);
    }
    .progress-container:active .progress-handle { opacity: 1; }

    .time-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
    }

    /* ======== GESTURE OVERLAY ======== */
    .gesture-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      z-index: 10;
    }
    .gesture-left, .gesture-right {
      flex: 1; height: 100%;
    }

    /* ======== SKIP RIPPLE ANIMATION ======== */
    .skip-ripple {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      z-index: 50;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .skip-ripple.left  { left: 16px; }
    .skip-ripple.right { right: 16px; }
    .skip-ripple.show  { opacity: 1; }
    .skip-ripple .ripple-circle {
      width: 70px; height: 70px;
      border-radius: 50%;
      background: rgba(255,215,0,0.15);
      border: 2px solid rgba(255,215,0,0.5);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.6rem;
      color: var(--gold);
      backdrop-filter: blur(4px);
    }
    .skip-ripple span {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.5px;
    }

    /* ======== CENTER ICON ======== */
    .center-icon {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.7);
      width: 72px; height: 72px;
      background: rgba(255,215,0,0.95);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.9rem;
      color: #000;
      z-index: 40;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s, transform 0.2s cubic-bezier(0.34,1.56,0.64,1);
    }
    .center-icon.visible {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    /* ======== LOADING SPINNER ======== */
    #spinner {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 48px; height: 48px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      z-index: 50;
      display: none;
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    #spinner.show { display: block; }

    /* ======== PLAYLIST DRAWER ======== */
    .playlist-drawer {
      position: absolute;
      right: 0; top: 0; bottom: 0;
      width: 230px;
      background: rgba(8,8,8,0.97);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-left: 1px solid rgba(255,215,0,0.15);
      z-index: 30;
      transform: translateX(100%);
      transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
      display: flex;
      flex-direction: column;
    }
    .playlist-drawer.open { transform: translateX(0); }

    .drawer-header {
      padding: 18px 20px 14px;
      border-bottom: 1px solid #1a1a1a;
      font-family: 'Bebas Neue', cursive;
      font-size: 1.2rem;
      color: var(--gold);
      letter-spacing: 2px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .drawer-close {
      background: none; border: none;
      color: #666; font-size: 1rem; cursor: pointer;
    }

    .drawer-list {
      overflow-y: auto;
      flex: 1;
      scrollbar-width: thin;
      scrollbar-color: #333 transparent;
    }

    .drawer-item {
      padding: 13px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      color: #ccc;
      font-size: 0.85rem;
      font-weight: 500;
      transition: background 0.15s, padding-left 0.15s;
      position: relative;
    }
    .drawer-item:active { background: rgba(255,215,0,0.08); }
    .drawer-item.active {
      background: rgba(255,215,0,0.1);
      color: var(--gold);
      border-left: 3px solid var(--gold);
      padding-left: 17px;
    }
    .drawer-item.locked { color: #555; }
    .drawer-item.locked .lock-icon {
      margin-left: auto;
      color: var(--gold);
      font-size: 0.8rem;
    }
    .drawer-item .ep-num {
      font-family: 'Bebas Neue', cursive;
      font-size: 1.1rem;
      color: var(--gold);
      width: 30px;
      flex-shrink: 0;
    }
    .drawer-item.locked .ep-num { color: #555; }

    /* Drawer overlay backdrop */
    .drawer-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 29;
      display: none;
    }
    .drawer-backdrop.show { display: block; }

    /* ======== NEXT EPISODE OVERLAY ======== */
    .next-overlay {
      position: absolute;
      bottom: 110px;
      left: 16px; right: 16px;
      background: rgba(15,15,15,0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 16px 20px;
      border: 1px solid var(--gold-dim);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 35;
      transform: translateY(120px);
      opacity: 0;
      transition: all 0.35s cubic-bezier(0.34,1.3,0.64,1);
      pointer-events: none;
    }
    .next-overlay.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }
    .next-info { flex: 1; }
    .next-label { font-size: 0.65rem; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
    .next-title { font-weight: 600; font-size: 0.92rem; margin-top: 2px; }
    .next-actions { display: flex; gap: 14px; }
    .next-btn {
      background: none; border: none;
      color: white; font-size: 1.2rem;
      cursor: pointer; padding: 6px;
      transition: color 0.15s;
    }
    .next-btn:active { color: var(--gold); }

    /* ======== TOAST ======== */
    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: rgba(20,20,20,0.95);
      color: white;
      border: 1px solid #333;
      padding: 10px 22px;
      border-radius: 40px;
      font-size: 0.82rem;
      font-weight: 600;
      z-index: 999;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.34,1.3,0.64,1);
      pointer-events: none;
      white-space: nowrap;
      backdrop-filter: blur(8px);
    }
    #toast.on {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ======== SWIPE HINT ======== */
    .swipe-hint {
      position: absolute;
      top: 50%;
      right: 16px;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
      animation: swipeHintAnim 2s ease-in-out;
      z-index: 15;
    }
    .swipe-hint i { font-size: 1.4rem; color: rgba(255,255,255,0.6); animation: bounce 0.6s ease-in-out infinite alternate; }
    .swipe-hint span { font-size: 0.65rem; color: rgba(255,255,255,0.5); letter-spacing: 0.5px; }
    @keyframes swipeHintAnim {
      0%   { opacity: 0; } 20%  { opacity: 1; }
      80%  { opacity: 1; } 100% { opacity: 0; }
    }
    @keyframes bounce { to { transform: translateY(-6px); } }

    /* ======== EPISODE TRANSITION ======== */
    .reel-slide.transitioning-out {
      animation: slideOutUp 0.35s ease forwards;
    }
    .reel-slide.transitioning-in {
      animation: slideInUp 0.35s ease forwards;
    }
    @keyframes slideOutUp { to { opacity: 0.3; filter: blur(2px) scale(0.98); } }
    @keyframes slideInUp  { from { opacity: 0.3; filter: blur(2px) scale(0.98); } to { opacity: 1; filter: none; } }

    /* ======== ERROR STATE ======== */
    .video-error {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      background: rgba(0,0,0,0.85);
      z-index: 60;
    }
    .video-error.show { display: flex; }
    .video-error i { font-size: 3rem; color: var(--gold); }
    .video-error p { font-size: 0.9rem; color: #bbb; }
    .retry-btn {
      padding: 10px 28px;
      background: var(--gold);
      color: #000;
      border: none;
      border-radius: 40px;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>

  <!-- Single reel viewport -->
  <div id="reels-viewport">

    <!-- Single video wrapper (we move episodes via transforms) -->
    <div id="current-slide" style="position:relative;width:100%;height:100%;background:#000;">

      <video id="video" playsinline preload="auto" disablepictureinpicture
             x-webkit-airplay="deny"></video>

      <!-- Gesture overlay: left / right for double-tap skip -->
      <div class="gesture-overlay">
        <div class="gesture-left"  id="gesture-left"></div>
        <div class="gesture-right" id="gesture-right"></div>
      </div>

      <!-- Skip ripples -->
      <div class="skip-ripple left" id="skip-left">
        <div class="ripple-circle"><i class="fas fa-backward"></i></div>
        <span>10 SEC</span>
      </div>
      <div class="skip-ripple right" id="skip-right">
        <div class="ripple-circle"><i class="fas fa-forward"></i></div>
        <span>10 SEC</span>
      </div>

      <!-- Top bar -->
      <div class="top-bar" id="top-bar">
        <button class="icon-btn" id="back-btn" aria-label="Back">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="show-title" id="show-title">‚Ä¶</div>
        <button class="icon-btn playlist-btn" id="playlist-toggle" aria-label="Episodes">
          <i class="fas fa-list-ul"></i>
        </button>
      </div>

      <!-- Bottom bar -->
      <div class="bottom-bar" id="bottom-bar">
        <div class="episode-info">
          <div class="episode-title" id="ep-title"></div>
          <div class="episode-meta" id="ep-meta"></div>
        </div>

        <!-- Controls row -->
        <div class="controls-row">
          <button class="play-pause-btn" id="play-pause-btn" aria-label="Play/Pause">
            <i class="fas fa-play" id="pp-icon"></i>
          </button>
          <button class="vol-btn icon-btn" id="vol-btn" aria-label="Mute">
            <i class="fas fa-volume-up" id="vol-icon"></i>
          </button>
          <span class="ep-counter" id="ep-counter">Ep 1 / 1</span>
        </div>

        <!-- Progress bar -->
        <div class="progress-container" id="progress-container" role="slider" aria-label="Seek">
          <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
            <div class="progress-handle" id="progress-handle"></div>
          </div>
        </div>
        <div class="time-row">
          <span id="current-time">0:00</span>
          <span id="duration">--:--</span>
        </div>
      </div>

      <!-- Playlist drawer backdrop -->
      <div class="drawer-backdrop" id="drawer-backdrop"></div>

      <!-- Playlist drawer -->
      <div class="playlist-drawer" id="playlist-drawer">
        <div class="drawer-header">
          <span>EPISODES</span>
          <button class="drawer-close" id="drawer-close" aria-label="Close">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="drawer-list" id="drawer-list"></div>
      </div>

      <!-- Next episode overlay -->
      <div class="next-overlay" id="nextOverlay">
        <div class="next-info">
          <div class="next-label">‡§Ö‡§ó‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§°</div>
          <div class="next-title" id="next-title"></div>
        </div>
        <div class="next-actions">
          <button class="next-btn" id="next-cancel" aria-label="Cancel"><i class="fas fa-times"></i></button>
          <button class="next-btn" id="next-go"     aria-label="Play next"><i class="fas fa-step-forward"></i></button>
        </div>
      </div>

      <!-- Center feedback icon -->
      <div class="center-icon" id="centerIcon"><i class="fas fa-play"></i></div>

      <!-- Spinner -->
      <div id="spinner"></div>

      <!-- Error state -->
      <div class="video-error" id="video-error">
        <i class="fas fa-exclamation-triangle"></i>
        <p>‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü</p>
        <button class="retry-btn" id="retry-btn">‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>
    </div>

  </div>

  <!-- Global toast -->
  <div id="toast" role="status"></div>

<script>
(function () {
  'use strict';

  /* =====================================================
     SECURITY
  ===================================================== */
  document.addEventListener('contextmenu', e => e.preventDefault(), true);
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && 'suacjip'.includes(e.key.toLowerCase())) e.preventDefault();
    if (e.key === 'F12' || e.key === 'PrintScreen') e.preventDefault();
  }, true);
  ['dragstart','drop','selectstart'].forEach(evt =>
    document.addEventListener(evt, e => e.preventDefault(), true));
  document.addEventListener('touchstart', e => {
    if (e.target.tagName === 'VIDEO') e.preventDefault();
  }, { passive: false });

  /* =====================================================
     DEVICE FINGERPRINT  (per-device, per-user cache)
  ===================================================== */
  function getDeviceId() {
    let id = localStorage.getItem('btftv_device_id');
    if (!id) {
      const arr = new Uint8Array(16);
      crypto.getRandomValues(arr);
      id = [...arr].map(b => b.toString(16).padStart(2,'0')).join('');
      localStorage.setItem('btftv_device_id', id);
    }
    return id;
  }
  const DEVICE_ID  = getDeviceId();
  const CACHE_NAME = `btftv-v2-${DEVICE_ID}`;   // each device gets own cache bucket
  const CACHE_TTL  = 2 * 60 * 60 * 1000;         // 2 hours

  /* =====================================================
     SESSION / URL  ‚Äì per-episode URL parameter
  ===================================================== */
  const SESSION_TTL = 60 * 60 * 1000; // 1 hour
  const CODE_LEN    = 22;

  function genCode() {
    const ch = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let r = '';
    for (let i = 0; i < CODE_LEN; i++) r += ch[Math.floor(Math.random() * ch.length)];
    return r;
  }

  // Save mapping: code ‚Üí { sid, ei, expiry }
  function saveMapping(code, sid, ei) {
    const map = JSON.parse(localStorage.getItem('btftv_codes') || '{}');
    map[code] = { sid, ei, expiry: Date.now() + SESSION_TTL };
    // Prune expired codes
    for (const k in map) if (map[k].expiry < Date.now()) delete map[k];
    localStorage.setItem('btftv_codes', JSON.stringify(map));
  }

  function loadMapping(code) {
    const map = JSON.parse(localStorage.getItem('btftv_codes') || '{}');
    const d = map[code];
    if (d && d.expiry > Date.now()) return d;
    return null;
  }

  const urlParams = new URLSearchParams(location.search);
  let code = urlParams.get('code');
  let sid, ei;

  if (code) {
    const d = loadMapping(code);
    if (d) { sid = d.sid; ei = d.ei; }
    else {
      toastMsg('‡§∏‡•á‡§∂‡§® ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‚Äî ‡§™‡•Å‡§®‡§É ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç');
      setTimeout(() => location.href = 'index.html', 2000);
      return;
    }
  } else {
    sid = urlParams.get('sid');
    ei  = parseInt(urlParams.get('ei') || '0', 10);
    if (!sid) {
      toastMsg('‡§ï‡•ã‡§à ‡§∂‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ');
      setTimeout(() => location.href = 'index.html', 2000);
      return;
    }
    code = genCode();
    saveMapping(code, sid, ei);
    // Redirect to clean URL with short code
    window.location.replace(`${location.pathname}?code=${code}`);
    return;
  }

  /* =====================================================
     STATE
  ===================================================== */
  let show            = null;
  let D               = null;
  let currentEpIndex  = ei;
  let autoNextTimer   = null;
  let hideCtrlTimer   = null;
  let isDragProg      = false;
  let controlsVisible = true;
  let isMuted         = false;

  // Touch tracking
  let touchStartX = 0, touchStartY = 0, touchStartTime = 0, lastTapTime = 0;
  const SWIPE_THRESH = 55, DTAP_DELAY = 280;

  // Watch history ‚Äî keyed per device per show/episode
  const H_KEY = `btftv_h_${DEVICE_ID}`;
  let histData = JSON.parse(localStorage.getItem(H_KEY) || '{}');

  /* =====================================================
     DOM REFS
  ===================================================== */
  const video        = document.getElementById('video');
  const progFill     = document.getElementById('progress-fill');
  const progHandle   = document.getElementById('progress-handle');
  const progCont     = document.getElementById('progress-container');
  const curTimeEl    = document.getElementById('current-time');
  const durEl        = document.getElementById('duration');
  const drawer       = document.getElementById('playlist-drawer');
  const drawerList   = document.getElementById('drawer-list');
  const backdrop     = document.getElementById('drawer-backdrop');
  const nextOverlay  = document.getElementById('nextOverlay');
  const nextTitleEl  = document.getElementById('next-title');
  const spinner      = document.getElementById('spinner');
  const centerIcon   = document.getElementById('centerIcon');
  const toastEl      = document.getElementById('toast');
  const topBar       = document.getElementById('top-bar');
  const bottomBar    = document.getElementById('bottom-bar');
  const ppBtn        = document.getElementById('play-pause-btn');
  const ppIcon       = document.getElementById('pp-icon');
  const volBtn       = document.getElementById('vol-btn');
  const volIcon      = document.getElementById('vol-icon');
  const epCounter    = document.getElementById('ep-counter');
  const errorBox     = document.getElementById('video-error');
  const skipLeft     = document.getElementById('skip-left');
  const skipRight    = document.getElementById('skip-right');

  let skipLeftTimer = null, skipRightTimer = null;

  /* =====================================================
     TOAST
  ===================================================== */
  let toastTimer;
  function toastMsg(msg) {
    clearTimeout(toastTimer);
    toastEl.textContent = msg;
    toastEl.classList.add('on');
    toastTimer = setTimeout(() => toastEl.classList.remove('on'), 2800);
  }

  /* =====================================================
     TIME FORMAT
  ===================================================== */
  function fmt(s) {
    if (!s || isNaN(s)) return '0:00';
    const m = Math.floor(s / 60), ss = Math.floor(s % 60);
    return m + ':' + (ss < 10 ? '0' : '') + ss;
  }

  /* =====================================================
     CACHE ‚Äî per-device
  ===================================================== */
  async function getCached(url) {
    if (!('caches' in window)) return null;
    try {
      const c = await caches.open(CACHE_NAME);
      const r = await c.match(url);
      if (!r) return null;
      const t = r.headers.get('x-btf-cached');
      if (t && (Date.now() - parseInt(t)) < CACHE_TTL) return r;
      await c.delete(url);
      return null;
    } catch { return null; }
  }

  async function setCache(url, blob) {
    if (!('caches' in window)) return;
    try {
      const c = await caches.open(CACHE_NAME);
      const h = new Headers({ 'Content-Type': 'video/mp4', 'x-btf-cached': Date.now().toString() });
      await c.put(url, new Response(blob, { headers: h }));
    } catch (e) { console.warn('cache set failed', e); }
  }

  /* =====================================================
     VIDEO LOAD WITH CACHE
  ===================================================== */
  let blobUrl = null;

  async function loadVideo(url) {
    spinner.classList.add('show');
    errorBox.classList.remove('show');
    video.pause();
    video.src = '';
    if (blobUrl) { URL.revokeObjectURL(blobUrl); blobUrl = null; }

    try {
      const cached = await getCached(url);
      if (cached) {
        blobUrl = URL.createObjectURL(await cached.blob());
        video.src = blobUrl;
      } else {
        // Stream directly for speed; cache in background
        video.src = url;
        fetch(url, { mode: 'cors' })
          .then(r => r.ok ? r.blob() : null)
          .then(b => { if (b) setCache(url, b); })
          .catch(() => {});
      }
      video.load();
      video.play().catch(() => {});
    } catch (e) {
      toastMsg('‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü');
      errorBox.classList.add('show');
    } finally {
      spinner.classList.remove('show');
    }
  }

  /* =====================================================
     UPDATE URL when episode changes (per-episode URL)
  ===================================================== */
  function updateEpisodeUrl(epIndex) {
    const ep = show.episodes[epIndex];
    if (!ep) return;
    // Store mapping with new episode index
    saveMapping(code, sid, epIndex);
    // Update browser URL without reload ‚Äî episode-specific
    const newUrl = `${location.pathname}?code=${code}&ep=${epIndex}`;
    history.replaceState({ sid, ep: epIndex }, document.title, newUrl);
  }

  /* =====================================================
     LOAD DATA
  ===================================================== */
  async function loadData() {
    try {
      const res = await fetch('https://storytv.btfcompanystorage.workers.dev/data');
      if (!res.ok) throw new Error('bad response');
      D = await res.json();
    } catch {
      toastMsg('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü'); return;
    }

    show = D.shows.find(s => s.id === sid);
    if (!show) { toastMsg('‡§∂‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ'); return; }

    if (D.site?.favicon_url) {
      let lk = document.querySelector("link[rel='icon']") || document.createElement('link');
      lk.rel = 'icon'; lk.href = D.site.favicon_url;
      document.head.appendChild(lk);
    }

    document.getElementById('show-title').textContent = show.title || 'BTF TV';
    buildPlaylist();
    loadEpisode(currentEpIndex, true);

    // Show swipe hint on first visit
    if (!localStorage.getItem('btftv_hint_shown')) {
      const hint = document.createElement('div');
      hint.className = 'swipe-hint';
      hint.innerHTML = '<i class="fas fa-arrows-alt-v"></i><span>SWIPE</span>';
      document.getElementById('current-slide').appendChild(hint);
      setTimeout(() => hint.remove(), 2200);
      localStorage.setItem('btftv_hint_shown', '1');
    }
  }

  /* =====================================================
     LOAD EPISODE
  ===================================================== */
  function loadEpisode(index, instant = false) {
    const ep = show.episodes[index];
    if (!ep) return;

    currentEpIndex = index;

    // Update UI
    document.getElementById('ep-title').textContent = ep.title || `‡§è‡§™‡§ø‡§∏‡•ã‡§° ${ep.ep}`;
    document.getElementById('ep-meta').innerHTML =
      `<span><i class="fas fa-film"></i> Ep ${ep.ep}</span>` +
      `<span>¬∑</span><span>${ep.duration || '--'}</span>` +
      `<span>¬∑</span><span>${show.language || 'Hindi'}</span>`;
    document.title = `Ep ${ep.ep} ‚Äì ${show.title} | BTF TV`;

    epCounter.textContent = `Ep ${ep.ep} / ${show.episodes.length}`;

    // Per-episode URL update
    updateEpisodeUrl(index);

    // Highlight active in playlist
    document.querySelectorAll('.drawer-item').forEach((item, i) => {
      item.classList.toggle('active', i === index);
    });

    // Load video
    loadVideo(ep.video_url);

    // Restore progress
    const key = `${sid}_${index}`;
    const saved = histData[key]?.t || 0;
    if (saved > 3) {
      const onCP = () => { video.currentTime = saved; video.removeEventListener('canplay', onCP); };
      video.addEventListener('canplay', onCP);
    }

    hideNextOverlay();
    resetProgress();
  }

  function resetProgress() {
    progFill.style.width = '0%';
    progHandle.style.left = '0%';
    curTimeEl.textContent = '0:00';
    durEl.textContent = '--:--';
  }

  /* =====================================================
     PLAYLIST
  ===================================================== */
  function buildPlaylist() {
    let html = '';
    show.episodes.forEach((ep, i) => {
      const active = i === currentEpIndex ? 'active' : '';
      const locked = ep.is_free ? '' : 'locked';
      html += `<div class="drawer-item ${active} ${locked}" data-index="${i}">
        <span class="ep-num">${ep.ep}</span>
        <span class="ep-label">${ep.title || 'Episode ' + ep.ep}</span>
        ${!ep.is_free ? '<i class="fas fa-lock lock-icon"></i>' : ''}
      </div>`;
    });
    drawerList.innerHTML = html;

    drawerList.querySelectorAll('.drawer-item').forEach(item => {
      item.addEventListener('click', () => {
        const idx = parseInt(item.dataset.index, 10);
        if (idx === currentEpIndex) { closeDrawer(); return; }
        const ep = show.episodes[idx];
        if (!ep.is_free) { toastMsg('üîí ‡§Ø‡§π ‡§è‡§™‡§ø‡§∏‡•ã‡§° GOLD ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨‡§∞‡•ç‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à'); return; }
        clearAutoNext();
        loadEpisode(idx);
        closeDrawer();
      });
    });
  }

  function openDrawer() {
    drawer.classList.add('open');
    backdrop.classList.add('show');
  }
  function closeDrawer() {
    drawer.classList.remove('open');
    backdrop.classList.remove('show');
  }

  document.getElementById('playlist-toggle').addEventListener('click', openDrawer);
  document.getElementById('drawer-close').addEventListener('click', closeDrawer);
  backdrop.addEventListener('click', closeDrawer);

  /* =====================================================
     CONTROLS SHOW / HIDE
  ===================================================== */
  function showControls() {
    controlsVisible = true;
    topBar.classList.remove('hidden');
    bottomBar.classList.remove('hidden');
    resetHideTimer();
  }

  function hideControls() {
    controlsVisible = false;
    topBar.classList.add('hidden');
    bottomBar.classList.add('hidden');
  }

  function resetHideTimer() {
    clearTimeout(hideCtrlTimer);
    if (!video.paused) {
      hideCtrlTimer = setTimeout(hideControls, 3000);
    }
  }

  /* =====================================================
     PLAY / PAUSE
  ===================================================== */
  function setPlayIcon(playing) {
    ppIcon.className = playing ? 'fas fa-pause' : 'fas fa-play';
  }

  function togglePlay() {
    if (video.paused) {
      video.play().catch(() => {});
    } else {
      video.pause();
    }
  }

  ppBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    togglePlay();
    flashCenter(video.paused ? 'pause' : 'play');
  });

  /* =====================================================
     VOLUME / MUTE
  ===================================================== */
  volBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    isMuted = !isMuted;
    video.muted = isMuted;
    volIcon.className = isMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
    toastMsg(isMuted ? 'üîá ‡§Æ‡•ç‡§Ø‡•Ç‡§ü' : 'üîä ‡§Ö‡§®‡§Æ‡•ç‡§Ø‡•Ç‡§ü');
  });

  /* =====================================================
     SKIP ANIMATION
  ===================================================== */
  function showSkip(dir) {
    if (dir === 'left') {
      skipLeft.classList.add('show');
      clearTimeout(skipLeftTimer);
      skipLeftTimer = setTimeout(() => skipLeft.classList.remove('show'), 600);
    } else {
      skipRight.classList.add('show');
      clearTimeout(skipRightTimer);
      skipRightTimer = setTimeout(() => skipRight.classList.remove('show'), 600);
    }
  }

  function skip(sec) {
    video.currentTime = Math.max(0, Math.min(video.duration || 0, video.currentTime + sec));
  }

  /* =====================================================
     CENTER ICON FLASH
  ===================================================== */
  let centerTimer;
  function flashCenter(action) {
    clearTimeout(centerTimer);
    if (action === 'play')     centerIcon.innerHTML = '<i class="fas fa-play"></i>';
    else if (action === 'pause')  centerIcon.innerHTML = '<i class="fas fa-pause"></i>';
    centerIcon.classList.add('visible');
    centerTimer = setTimeout(() => centerIcon.classList.remove('visible'), 600);
  }

  /* =====================================================
     EPISODE CHANGE WITH SMOOTH TRANSITION
  ===================================================== */
  function changeEpisode(dir) {
    const newIdx = currentEpIndex + dir;
    if (newIdx < 0 || newIdx >= show.episodes.length) {
      toastMsg(dir > 0 ? 'üì∫ ‡§Ü‡§ñ‡§ø‡§∞‡•Ä ‡§è‡§™‡§ø‡§∏‡•ã‡§° ‡§π‡•à' : 'üì∫ ‡§™‡§π‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§° ‡§π‡•à');
      return;
    }
    const ep = show.episodes[newIdx];
    if (!ep.is_free) { toastMsg('üîí ‡§Ø‡§π ‡§è‡§™‡§ø‡§∏‡•ã‡§° GOLD ‡§π‡•à'); return; }

    clearAutoNext();

    // Slide transition effect
    const slide = document.getElementById('current-slide');
    slide.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
    slide.style.transform = `translateY(${dir < 0 ? '30px' : '-30px'})`;
    slide.style.opacity = '0.3';

    setTimeout(() => {
      slide.style.transition = 'none';
      slide.style.transform = `translateY(${dir < 0 ? '-30px' : '30px'})`;
      slide.style.opacity = '0.3';
      loadEpisode(newIdx);
      // Force reflow
      void slide.offsetHeight;
      slide.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
      slide.style.transform = 'translateY(0)';
      slide.style.opacity = '1';
    }, 300);
  }

  /* =====================================================
     TOUCH GESTURES ‚Äî gesture overlay
  ===================================================== */
  const gestureZone = document.querySelector('.gesture-overlay');

  gestureZone.addEventListener('touchstart', (e) => {
    const t = e.touches[0];
    touchStartX = t.clientX;
    touchStartY = t.clientY;
    touchStartTime = Date.now();
  }, { passive: true });

  gestureZone.addEventListener('touchend', (e) => {
    const t = e.changedTouches[0];
    const dX = t.clientX - touchStartX;
    const dY = t.clientY - touchStartY;
    const dt = Date.now() - touchStartTime;
    const now = Date.now();

    // Double-tap detection
    if ((now - lastTapTime) < DTAP_DELAY && Math.abs(dX) < 25 && Math.abs(dY) < 25) {
      if (t.clientX < window.innerWidth / 2) {
        skip(-10); showSkip('left');
      } else {
        skip(10); showSkip('right');
      }
      lastTapTime = 0;
      return;
    }

    // Vertical swipe ‚Üí episode change
    if (Math.abs(dY) > SWIPE_THRESH && Math.abs(dY) > Math.abs(dX) * 1.5) {
      changeEpisode(dY < 0 ? 1 : -1);
      lastTapTime = now;
      return;
    }

    // Single tap ‚Üí toggle controls visibility only (NOT play/pause)
    if (Math.abs(dX) < 15 && Math.abs(dY) < 15 && dt < 300) {
      if (drawer.classList.contains('open')) { closeDrawer(); }
      else if (controlsVisible) { hideControls(); }
      else { showControls(); }
    }

    lastTapTime = now;
  }, { passive: true });

  /* =====================================================
     PROGRESS BAR
  ===================================================== */
  progCont.addEventListener('touchstart', (e) => {
    isDragProg = true;
    applyProgress(e.touches[0], false);
    e.stopPropagation();
    e.preventDefault();
  }, { passive: false });

  document.addEventListener('touchmove', (e) => {
    if (isDragProg) { applyProgress(e.touches[0], false); e.preventDefault(); }
  }, { passive: false });

  document.addEventListener('touchend', (e) => {
    if (isDragProg) {
      isDragProg = false;
      if (e.changedTouches[0]) applyProgress(e.changedTouches[0], true);
    }
  });

  // Mouse (desktop)
  progCont.addEventListener('mousedown', (e) => {
    isDragProg = true;
    applyProgressMouse(e, false);
    e.preventDefault();
  });
  document.addEventListener('mousemove', (e) => {
    if (isDragProg) applyProgressMouse(e, false);
  });
  document.addEventListener('mouseup', (e) => {
    if (isDragProg) { isDragProg = false; applyProgressMouse(e, true); }
  });

  function applyProgress(touch, seek) {
    const rect = progCont.getBoundingClientRect();
    let pos = Math.max(0, Math.min(1, (touch.clientX - rect.left) / rect.width));
    setProgressUI(pos);
    if (seek && video.duration) video.currentTime = pos * video.duration;
    else if (video.duration) curTimeEl.textContent = fmt(pos * video.duration);
  }

  function applyProgressMouse(e, seek) {
    const rect = progCont.getBoundingClientRect();
    let pos = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    setProgressUI(pos);
    if (seek && video.duration) video.currentTime = pos * video.duration;
    else if (video.duration) curTimeEl.textContent = fmt(pos * video.duration);
  }

  function setProgressUI(pos) {
    progFill.style.width  = (pos * 100) + '%';
    progHandle.style.left = (pos * 100) + '%';
  }

  /* =====================================================
     VIDEO EVENTS
  ===================================================== */
  video.addEventListener('timeupdate', () => {
    if (isDragProg || !video.duration) return;
    const pct = video.currentTime / video.duration;
    setProgressUI(pct);
    curTimeEl.textContent = fmt(video.currentTime);
    // Save progress per device per episode
    const key = `${sid}_${currentEpIndex}`;
    histData[key] = { sid, ei: currentEpIndex, t: Math.round(video.currentTime), d: Math.round(video.duration) };
    try { localStorage.setItem(H_KEY, JSON.stringify(histData)); } catch {}
  });

  video.addEventListener('loadedmetadata', () => {
    durEl.textContent = fmt(video.duration);
  });

  video.addEventListener('play', () => {
    setPlayIcon(true);
    flashCenter('play');
    resetHideTimer();
  });

  video.addEventListener('pause', () => {
    setPlayIcon(false);
    showControls();
    clearTimeout(hideCtrlTimer);
  });

  video.addEventListener('waiting', () => spinner.classList.add('show'));
  video.addEventListener('canplay',  () => spinner.classList.remove('show'));
  video.addEventListener('error',    () => errorBox.classList.add('show'));

  video.addEventListener('ended', () => {
    if (currentEpIndex < show.episodes.length - 1) {
      const next = show.episodes[currentEpIndex + 1];
      nextTitleEl.textContent = `Ep ${next.ep}: ${next.title}`;
      nextOverlay.classList.add('show');
      autoNextTimer = setTimeout(() => {
        if (next.is_free) { currentEpIndex++; loadEpisode(currentEpIndex); }
        else { toastMsg('üîí ‡§Ö‡§ó‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§° GOLD ‡§π‡•à'); hideNextOverlay(); }
      }, 5000);
    }
    showControls();
  });

  /* =====================================================
     RETRY BUTTON
  ===================================================== */
  document.getElementById('retry-btn').addEventListener('click', () => {
    errorBox.classList.remove('show');
    loadEpisode(currentEpIndex);
  });

  /* =====================================================
     NEXT OVERLAY CONTROLS
  ===================================================== */
  document.getElementById('next-cancel').addEventListener('click', () => {
    clearAutoNext(); hideNextOverlay();
  });
  document.getElementById('next-go').addEventListener('click', () => {
    clearAutoNext();
    if (currentEpIndex < show.episodes.length - 1) {
      const next = show.episodes[currentEpIndex + 1];
      if (!next.is_free) { toastMsg('üîí GOLD ‡§ö‡§æ‡§π‡§ø‡§è'); hideNextOverlay(); return; }
      currentEpIndex++;
      loadEpisode(currentEpIndex);
    }
  });

  function hideNextOverlay() { nextOverlay.classList.remove('show'); }
  function clearAutoNext()   { if (autoNextTimer) clearTimeout(autoNextTimer); autoNextTimer = null; }

  /* =====================================================
     BACK BUTTON
  ===================================================== */
  document.getElementById('back-btn').addEventListener('click', () => {
    video.pause();
    if (blobUrl) { URL.revokeObjectURL(blobUrl); blobUrl = null; }
    history.back();
  });

  /* =====================================================
     KEYBOARD SHORTCUTS (desktop)
  ===================================================== */
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    if (e.key === ' ' || e.key === 'k')        { e.preventDefault(); togglePlay(); }
    else if (e.key === 'ArrowRight' || e.key === 'l') { skip(10); showSkip('right'); }
    else if (e.key === 'ArrowLeft'  || e.key === 'j') { skip(-10); showSkip('left'); }
    else if (e.key === 'ArrowUp')   changeEpisode(-1);
    else if (e.key === 'ArrowDown') changeEpisode(1);
    else if (e.key === 'm')         volBtn.click();
    showControls();
  });

  /* =====================================================
     BROWSER BACK/FORWARD ‚Üí update episode
  ===================================================== */
  window.addEventListener('popstate', (e) => {
    if (e.state?.ep != null) loadEpisode(e.state.ep, true);
  });

  /* =====================================================
     VISIBILITY CHANGE ‚Äî pause when tab hidden
  ===================================================== */
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) video.pause();
  });

  /* =====================================================
     INIT
  ===================================================== */
  loadData();

})();
</script>
</body>
</html>
