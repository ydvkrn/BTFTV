<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>BTF TV</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}
    :root{--gold:#FFD700;--gold-dim:rgba(255,215,0,.25);--dark:rgba(8,8,8,.97)}
    html,body{height:100%;width:100%;overflow:hidden;background:#000;font-family:'Poppins',sans-serif;color:#fff}
    #player{position:fixed;inset:0;background:#000}
    #video{width:100%;height:100%;object-fit:contain;background:#000;pointer-events:none;display:block}

    /* GESTURE */
    #gest{position:absolute;inset:0;z-index:10;display:flex}
    .gl,.gr{flex:1;height:100%}

    /* TOP BAR */
    #top-bar{position:absolute;top:0;left:0;right:0;padding:max(env(safe-area-inset-top,16px),16px) 14px 14px;background:linear-gradient(to bottom,rgba(0,0,0,.82) 0%,transparent 100%);z-index:20;display:flex;align-items:center;gap:10px;transition:opacity .25s,visibility .25s}
    #top-bar.hide{opacity:0;visibility:hidden;pointer-events:none}

    /* BOTTOM BAR */
    #bot-bar{position:absolute;bottom:0;left:0;right:0;padding:14px 14px max(env(safe-area-inset-bottom,20px),20px);background:linear-gradient(to top,rgba(0,0,0,.9) 0%,transparent 100%);z-index:20;transition:opacity .25s,visibility .25s}
    #bot-bar.hide{opacity:0;visibility:hidden;pointer-events:none}

    /* ICON BTN */
    .ibtn{width:40px;height:40px;border-radius:50%;background:rgba(28,28,28,.88);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:#fff;cursor:pointer;flex-shrink:0;transition:background .12s,transform .1s}
    .ibtn:active{transform:scale(.9);background:var(--gold);color:#000}
    .ibtn.gold{color:var(--gold);border-color:var(--gold-dim)}

    #show-title{font-family:'Bebas Neue',cursive;font-size:1.35rem;letter-spacing:1px;text-shadow:0 2px 8px rgba(0,0,0,.9);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* EPISODE INFO */
    #ep-title{font-family:'Bebas Neue',cursive;font-size:1.75rem;color:var(--gold);line-height:1.1;letter-spacing:1px;text-shadow:0 2px 10px rgba(0,0,0,.8);margin-bottom:4px}
    #ep-meta{font-size:.7rem;color:rgba(255,255,255,.6);display:flex;align-items:center;gap:6px;margin-bottom:12px}
    #ep-meta .dot{opacity:.4}

    /* CONTROLS ROW */
    #ctrl-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    #pp-btn{width:46px;height:46px;border-radius:50%;background:var(--gold);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#000;flex-shrink:0;box-shadow:0 4px 18px rgba(255,215,0,.45);transition:transform .1s}
    #pp-btn:active{transform:scale(.88)}
    #ep-ctr{margin-left:auto;font-size:.7rem;color:rgba(255,255,255,.5);font-weight:600;letter-spacing:.5px}

    /* PROGRESS */
    #prog-wrap{width:100%;height:24px;display:flex;align-items:center;cursor:pointer;touch-action:none}
    #prog-track{flex:1;height:3px;background:rgba(255,255,255,.18);border-radius:4px;position:relative;transition:height .15s}
    #prog-wrap:active #prog-track{height:5px}
    #prog-fill{height:100%;background:var(--gold);border-radius:4px;width:0%;pointer-events:none}
    #prog-hnd{width:13px;height:13px;background:var(--gold);border-radius:50%;position:absolute;top:50%;left:0%;transform:translate(-50%,-50%);opacity:0;pointer-events:none;transition:opacity .15s;box-shadow:0 2px 8px rgba(255,215,0,.5)}
    #prog-wrap:active #prog-hnd{opacity:1}
    #time-row{display:flex;justify-content:space-between;font-size:.63rem;color:rgba(255,255,255,.5);margin-top:4px}

    /* SKIP RIPPLE */
    .skip-rp{position:absolute;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;align-items:center;gap:6px;z-index:50;pointer-events:none;opacity:0;transition:opacity .15s}
    .skip-rp.L{left:20px}.skip-rp.R{right:20px}
    .skip-rp.on{opacity:1}
    .sk-circle{width:68px;height:68px;border-radius:50%;background:rgba(255,215,0,.12);border:2px solid rgba(255,215,0,.45);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--gold);backdrop-filter:blur(4px)}
    .skip-rp span{font-size:.65rem;font-weight:700;color:var(--gold);letter-spacing:.5px}

    /* CENTER ICON */
    #ci{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.6);width:70px;height:70px;border-radius:50%;background:rgba(255,215,0,.92);display:flex;align-items:center;justify-content:center;font-size:1.8rem;color:#000;z-index:40;opacity:0;pointer-events:none;transition:opacity .2s,transform .25s cubic-bezier(.34,1.56,.64,1)}
    #ci.on{opacity:1;transform:translate(-50%,-50%) scale(1)}

    /* SPINNER */
    #spin{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:46px;height:46px;border:3px solid rgba(255,255,255,.08);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;z-index:55;display:none}
    #spin.on{display:block}
    @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

    /* ERROR BOX ‚Äî only .on triggers display */
    #err{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;background:rgba(0,0,0,.65);z-index:60}
    #err.on{display:flex}
    #err i{font-size:2.8rem;color:var(--gold)}
    #err p{font-size:.88rem;color:#bbb}
    #retry{padding:10px 28px;background:var(--gold);color:#000;border:none;border-radius:40px;font-weight:700;font-size:.85rem;cursor:pointer}
    #retry:active{transform:scale(.95)}

    /* DRAWER */
    #dback{position:absolute;inset:0;background:rgba(0,0,0,.55);z-index:29;display:none}
    #dback.on{display:block}
    #drawer{position:absolute;right:0;top:0;bottom:0;width:235px;z-index:30;background:var(--dark);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-left:1px solid rgba(255,215,0,.12);transform:translateX(100%);transition:transform .28s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column}
    #drawer.on{transform:translateX(0)}
    .dhead{padding:18px 18px 12px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between}
    .dhead span{font-family:'Bebas Neue',cursive;font-size:1.15rem;color:var(--gold);letter-spacing:2px}
    .dcls{background:none;border:none;color:#666;font-size:1rem;cursor:pointer}
    #dlist{overflow-y:auto;flex:1;scrollbar-width:thin;scrollbar-color:#2a2a2a transparent}
    .di{padding:12px 18px;border-bottom:1px solid rgba(255,255,255,.04);display:flex;align-items:center;gap:10px;cursor:pointer;color:#aaa;font-size:.83rem;font-weight:500;transition:background .15s}
    .di:active{background:rgba(255,215,0,.08)}
    .di.active{background:rgba(255,215,0,.1);color:var(--gold);border-left:3px solid var(--gold);padding-left:15px}
    .di.locked{color:#555;cursor:default}
    .dnum{font-family:'Bebas Neue',cursive;font-size:1.1rem;color:var(--gold);width:28px;flex-shrink:0}
    .di.locked .dnum{color:#444}
    .dlk{margin-left:auto;color:var(--gold);font-size:.75rem}

    /* NEXT OVERLAY */
    #next-ov{position:absolute;bottom:105px;left:14px;right:14px;background:rgba(12,12,12,.95);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);border:1px solid var(--gold-dim);border-radius:14px;padding:14px 18px;z-index:35;display:flex;align-items:center;justify-content:space-between;transform:translateY(130px);opacity:0;pointer-events:none;transition:transform .35s cubic-bezier(.34,1.3,.64,1),opacity .3s}
    #next-ov.on{transform:translateY(0);opacity:1;pointer-events:auto}
    .ni{flex:1}
    .nlbl{font-size:.62rem;color:var(--gold);text-transform:uppercase;letter-spacing:1px}
    .ntit{font-weight:600;font-size:.9rem;margin-top:2px}
    .nact{display:flex;gap:12px}
    .nbtn{background:none;border:none;color:#fff;font-size:1.15rem;cursor:pointer;padding:6px}
    .nbtn:active{color:var(--gold)}

    /* TOAST */
    #toast{position:fixed;bottom:75px;left:50%;transform:translateX(-50%) translateY(18px);background:rgba(18,18,18,.95);color:#fff;border:1px solid #2a2a2a;padding:9px 22px;border-radius:40px;font-size:.8rem;font-weight:600;z-index:999;opacity:0;pointer-events:none;transition:all .28s cubic-bezier(.34,1.3,.64,1);white-space:nowrap;backdrop-filter:blur(8px);max-width:85vw;text-align:center}
    #toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

    /* SLIDE TRANSITION */
    @keyframes sld{from{opacity:.15;transform:translateY(var(--fy,35px))}to{opacity:1;transform:translateY(0)}}
    #player.sld{animation:sld .32s cubic-bezier(.25,.46,.45,.94) forwards}

    /* BUFFER LABEL */
    #buflbl{position:absolute;top:50%;left:50%;transform:translate(-50%,calc(-50% + 42px));font-size:.7rem;color:rgba(255,255,255,.45);z-index:56;display:none;letter-spacing:.5px}
    #buflbl.on{display:block}
  </style>
</head>
<body>
<div id="player">
  <video id="video" playsinline preload="auto" disablepictureinpicture x-webkit-airplay="deny"></video>

  <div id="gest"><div class="gl" id="gl"></div><div class="gr" id="gr"></div></div>

  <div class="skip-rp L" id="sk-l"><div class="sk-circle"><i class="fas fa-backward"></i></div><span>‚Äì10s</span></div>
  <div class="skip-rp R" id="sk-r"><div class="sk-circle"><i class="fas fa-forward"></i></div><span>+10s</span></div>

  <div id="top-bar">
    <button class="ibtn" id="back-btn"><i class="fas fa-arrow-left"></i></button>
    <div id="show-title">‚Ä¶</div>
    <button class="ibtn gold" id="pl-toggle"><i class="fas fa-list-ul"></i></button>
  </div>

  <div id="bot-bar">
    <div id="ep-title"></div>
    <div id="ep-meta"></div>
    <div id="ctrl-row">
      <button id="pp-btn"><i class="fas fa-play" id="pp-icon"></i></button>
      <button class="ibtn" id="vol-btn"><i class="fas fa-volume-up" id="vol-icon"></i></button>
      <span id="ep-ctr"></span>
    </div>
    <div id="prog-wrap">
      <div id="prog-track"><div id="prog-fill"></div><div id="prog-hnd"></div></div>
    </div>
    <div id="time-row"><span id="cur-t">0:00</span><span id="dur-t">--:--</span></div>
  </div>

  <div id="dback"></div>
  <div id="drawer">
    <div class="dhead"><span>EPISODES</span><button class="dcls" id="dcls"><i class="fas fa-times"></i></button></div>
    <div id="dlist"></div>
  </div>

  <div id="next-ov">
    <div class="ni"><div class="nlbl">‡§Ö‡§ó‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§°</div><div class="ntit" id="ntit"></div></div>
    <div class="nact">
      <button class="nbtn" id="n-cancel"><i class="fas fa-times"></i></button>
      <button class="nbtn" id="n-go"><i class="fas fa-step-forward"></i></button>
    </div>
  </div>

  <div id="ci"><i class="fas fa-play"></i></div>
  <div id="spin"></div>
  <div id="buflbl">‡§¨‡§´‡§∞‡§ø‡§Ç‡§ó‚Ä¶</div>

  <div id="err">
    <i class="fas fa-exclamation-triangle"></i>
    <p>‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü</p>
    <button id="retry">‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç</button>
  </div>
</div>
<div id="toast" role="status"></div>

<script>
(function(){
  'use strict';

  /* SECURITY */
  document.addEventListener('contextmenu',e=>e.preventDefault(),true);
  document.addEventListener('keydown',e=>{
    if((e.ctrlKey||e.metaKey)&&'suacjip'.includes(e.key.toLowerCase()))e.preventDefault();
    if(e.key==='F12'||e.key==='PrintScreen')e.preventDefault();
  },true);
  ['dragstart','drop','selectstart'].forEach(n=>document.addEventListener(n,e=>e.preventDefault(),true));
  document.addEventListener('touchstart',e=>{if(e.target.tagName==='VIDEO')e.preventDefault();},{passive:false});

  /* DEVICE ID */
  function getDevId(){
    let id=localStorage.getItem('btftv_dev');
    if(!id){const b=new Uint8Array(12);crypto.getRandomValues(b);id=[...b].map(x=>x.toString(16).padStart(2,'0')).join('');localStorage.setItem('btftv_dev',id);}
    return id;
  }
  const DEV=getDevId();
  const CACHE_NS='btftv3-'+DEV;
  const CACHE_TTL=2*60*60*1000;
  const H_KEY='btftv_h_'+DEV;

  /* SESSION */
  const SESSION_TTL=60*60*1000;
  function saveMap(code,sid,ei){
    const m=JSON.parse(localStorage.getItem('btftv_codes')||'{}');
    m[code]={sid,ei,exp:Date.now()+SESSION_TTL};
    for(const k in m)if(m[k].exp<Date.now())delete m[k];
    localStorage.setItem('btftv_codes',JSON.stringify(m));
  }
  function loadMap(code){const d=JSON.parse(localStorage.getItem('btftv_codes')||'{}')[code];return d&&d.exp>Date.now()?d:null;}
  function genCode(){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<22;i++)r+=c[Math.floor(Math.random()*c.length)];return r;}

  const UP=new URLSearchParams(location.search);
  let code=UP.get('code'),sid,startEp;
  if(code){
    const d=loadMap(code);
    if(d){sid=d.sid;startEp=d.ei;}
    else{toastMsg('‡§∏‡•á‡§∂‡§® ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‚Äî ‡§™‡•Å‡§®‡§É ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç');setTimeout(()=>location.href='index.html',2000);return;}
  }else{
    sid=UP.get('sid');startEp=parseInt(UP.get('ei')||'0',10);
    if(!sid){toastMsg('‡§∂‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ');setTimeout(()=>location.href='index.html',2000);return;}
    code=genCode();saveMap(code,sid,startEp);
    window.location.replace(location.pathname+'?code='+code);
    return;
  }

  /* STATE */
  let show=null,D=null,curEp=startEp;
  let nextTimer=null,hideTimer=null,isDrag=false;
  let ctrlVis=true,isMuted=false;
  let isLoading=false; /* ‚òÖ KEY: suppress premature error */
  let blobUrl=null;
  let slT=null,srT=null,ciT=null,toastT=null;
  let tx0=0,ty0=0,tt0=0,lastTap=0;
  const SW=55,DT=280;
  let hist=JSON.parse(localStorage.getItem(H_KEY)||'{}');

  /* DOM */
  const video=document.getElementById('video');
  const pFill=document.getElementById('prog-fill');
  const pHnd=document.getElementById('prog-hnd');
  const pWrap=document.getElementById('prog-wrap');
  const curT=document.getElementById('cur-t');
  const durT=document.getElementById('dur-t');
  const drawer=document.getElementById('drawer');
  const dList=document.getElementById('dlist');
  const dBack=document.getElementById('dback');
  const nextOv=document.getElementById('next-ov');
  const nTit=document.getElementById('ntit');
  const spin=document.getElementById('spin');
  const bufLbl=document.getElementById('buflbl');
  const ci=document.getElementById('ci');
  const toastEl=document.getElementById('toast');
  const topBar=document.getElementById('top-bar');
  const botBar=document.getElementById('bot-bar');
  const ppBtn=document.getElementById('pp-btn');
  const ppIco=document.getElementById('pp-icon');
  const volIco=document.getElementById('vol-icon');
  const errBox=document.getElementById('err');
  const skL=document.getElementById('sk-l');
  const skR=document.getElementById('sk-r');

  function toastMsg(msg){clearTimeout(toastT);toastEl.textContent=msg;toastEl.classList.add('on');toastT=setTimeout(()=>toastEl.classList.remove('on'),2800);}
  function fmt(s){if(!s||isNaN(s))return'0:00';const m=Math.floor(s/60),ss=Math.floor(s%60);return m+':'+(ss<10?'0':'')+ss;}

  /* CACHE */
  async function getCached(url){
    if(!('caches'in window))return null;
    try{const c=await caches.open(CACHE_NS),r=await c.match(url);if(!r)return null;const t=r.headers.get('x-btf-t');if(t&&(Date.now()-parseInt(t))<CACHE_TTL)return r;await c.delete(url);return null;}catch{return null;}
  }
  async function putCache(url,blob){
    if(!('caches'in window))return;
    try{const c=await caches.open(CACHE_NS),h=new Headers({'Content-Type':'video/mp4','x-btf-t':Date.now().toString()});await c.put(url,new Response(blob,{headers:h}));}catch(e){console.warn(e);}
  }

  /* ‚òÖ‚òÖ‚òÖ LOAD VIDEO ‚Äî isLoading flag prevents fake error display ‚òÖ‚òÖ‚òÖ */
  async function loadVideo(url){
    isLoading=true;             // ‚Üê SUPPRESS error events during reset
    errBox.classList.remove('on');
    spin.classList.add('on');
    bufLbl.classList.remove('on');

    try{video.pause();}catch{}
    video.removeAttribute('src');
    video.load();               // May fire 'error' internally ‚Äî we suppress it

    if(blobUrl){URL.revokeObjectURL(blobUrl);blobUrl=null;}

    // Wait for internal events to flush, THEN allow real errors
    await new Promise(r=>setTimeout(r,80));
    isLoading=false;            // ‚Üê NOW errors are genuine

    try{
      const cached=await getCached(url);
      if(cached){
        blobUrl=URL.createObjectURL(await cached.blob());
        video.src=blobUrl;
      }else{
        video.src=url;
        // Cache in background silently
        fetch(url,{mode:'cors'}).then(r=>r.ok?r.blob():null).then(b=>{if(b)putCache(url,b);}).catch(()=>{});
      }
      video.load();
      video.play().catch(()=>{});
    }catch(err){
      spin.classList.remove('on');
      errBox.classList.add('on');
    }
  }

  /* URL ‚Äî clean, no &ep= */
  function updateURL(epIdx){
    saveMap(code,sid,epIdx);
    history.replaceState({sid,ep:epIdx},document.title,location.pathname+'?code='+code);
  }

  /* LOAD DATA */
  async function loadData(){
    spin.classList.add('on');
    try{const res=await fetch('https://storytv.btfcompanystorage.workers.dev/data');if(!res.ok)throw new Error();D=await res.json();}
    catch{toastMsg('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü');spin.classList.remove('on');return;}
    show=D.shows.find(s=>s.id===sid);
    if(!show){toastMsg('‡§∂‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ');spin.classList.remove('on');return;}
    if(D.site?.favicon_url){const lk=document.querySelector("link[rel='icon']")||document.createElement('link');lk.rel='icon';lk.href=D.site.favicon_url;document.head.appendChild(lk);}
    document.getElementById('show-title').textContent=show.title||'BTF TV';
    buildPlaylist();
    loadEpisode(curEp,0);
  }

  /* LOAD EPISODE */
  function loadEpisode(idx,dir){
    const ep=show.episodes[idx];if(!ep)return;
    curEp=idx;
    document.getElementById('ep-title').textContent=ep.title||'‡§è‡§™‡§ø‡§∏‡•ã‡§° '+ep.ep;
    document.getElementById('ep-meta').innerHTML='<span>Ep '+ep.ep+'</span><span class="dot">‚Ä¢</span><span>'+(ep.duration||'--')+'</span><span class="dot">‚Ä¢</span><span>'+(show.language||'Hindi')+'</span>';
    document.title='Ep '+ep.ep+' ‚Äì '+show.title+' | BTF TV';
    document.getElementById('ep-ctr').textContent=ep.ep+' / '+show.episodes.length;
    updateURL(idx);
    hlDrawer(idx);

    if(dir!==0){
      const pl=document.getElementById('player');
      pl.style.setProperty('--fy',dir>0?'35px':'-35px');
      pl.classList.remove('sld');void pl.offsetWidth;pl.classList.add('sld');
      setTimeout(()=>pl.classList.remove('sld'),400);
    }

    loadVideo(ep.video_url);

    const key=sid+'_'+idx,saved=hist[key]?.t||0;
    if(saved>4){const f=()=>{video.currentTime=saved;video.removeEventListener('canplay',f);};video.addEventListener('canplay',f);}
    hideNextOv();resetProg();
  }

  function resetProg(){pFill.style.width='0%';pHnd.style.left='0%';curT.textContent='0:00';durT.textContent='--:--';}

  /* PLAYLIST */
  function buildPlaylist(){
    let h='';
    show.episodes.forEach((ep,i)=>{
      const a=i===curEp?'active':'',l=ep.is_free?'':'locked';
      h+='<div class="di '+a+' '+l+'" data-i="'+i+'"><span class="dnum">'+ep.ep+'</span><span>'+(ep.title||'Episode '+ep.ep)+'</span>'+(ep.is_free?'':'<i class="fas fa-lock dlk"></i>')+'</div>';
    });
    dList.innerHTML=h;
    dList.querySelectorAll('.di').forEach(el=>{
      el.addEventListener('click',()=>{
        const idx=parseInt(el.dataset.i,10);
        if(idx===curEp){closeDr();return;}
        if(!show.episodes[idx].is_free){toastMsg('üîí GOLD ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à');return;}
        clrNext();loadEpisode(idx,idx>curEp?1:-1);closeDr();
      });
    });
  }
  function hlDrawer(idx){dList.querySelectorAll('.di').forEach((el,i)=>el.classList.toggle('active',i===idx));}
  function openDr(){drawer.classList.add('on');dBack.classList.add('on');}
  function closeDr(){drawer.classList.remove('on');dBack.classList.remove('on');}
  document.getElementById('pl-toggle').addEventListener('click',openDr);
  document.getElementById('dcls').addEventListener('click',closeDr);
  dBack.addEventListener('click',closeDr);

  /* CONTROLS */
  function showCtrl(){ctrlVis=true;topBar.classList.remove('hide');botBar.classList.remove('hide');resetHT();}
  function hideCtrl(){ctrlVis=false;topBar.classList.add('hide');botBar.classList.add('hide');}
  function resetHT(){clearTimeout(hideTimer);if(!video.paused)hideTimer=setTimeout(hideCtrl,3000);}

  /* PLAY/PAUSE */
  function setPP(p){ppIco.className=p?'fas fa-pause':'fas fa-play';}
  function togglePlay(){if(video.paused)video.play().catch(()=>{});else video.pause();}
  ppBtn.addEventListener('click',e=>{e.stopPropagation();togglePlay();});

  /* MUTE */
  document.getElementById('vol-btn').addEventListener('click',e=>{
    e.stopPropagation();isMuted=!isMuted;video.muted=isMuted;
    volIco.className=isMuted?'fas fa-volume-mute':'fas fa-volume-up';
    toastMsg(isMuted?'üîá ‡§Æ‡•ç‡§Ø‡•Ç‡§ü':'üîä ‡§Ö‡§®‡§Æ‡•ç‡§Ø‡•Ç‡§ü');
  });

  /* SKIP */
  function showSkip(s){
    const el=s==='L'?skL:skR,t=s==='L'?slT:srT;
    clearTimeout(t);el.classList.add('on');
    const nt=setTimeout(()=>el.classList.remove('on'),700);
    if(s==='L')slT=nt;else srT=nt;
  }
  function skip(s){video.currentTime=Math.max(0,Math.min(video.duration||0,video.currentTime+s));}

  /* CENTER ICON */
  function flashCI(a){
    clearTimeout(ciT);
    ci.innerHTML=a==='play'?'<i class="fas fa-play"></i>':'<i class="fas fa-pause"></i>';
    ci.classList.add('on');ciT=setTimeout(()=>ci.classList.remove('on'),650);
  }

  /* EPISODE CHANGE */
  function changeEp(dir){
    const ni=curEp+dir;
    if(ni<0||ni>=show.episodes.length){toastMsg(dir>0?'üì∫ ‡§Ü‡§ñ‡§ø‡§∞‡•Ä ‡§è‡§™‡§ø‡§∏‡•ã‡§° ‡§π‡•à':'üì∫ ‡§™‡§π‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§° ‡§π‡•à');return;}
    if(!show.episodes[ni].is_free){toastMsg('üîí ‡§Ø‡§π GOLD ‡§π‡•à');return;}
    clrNext();loadEpisode(ni,dir);
  }

  /* ‚òÖ GESTURES: single tap = controls only (NOT play/pause) ‚òÖ */
  const gest=document.getElementById('gest');
  gest.addEventListener('touchstart',e=>{const t=e.touches[0];tx0=t.clientX;ty0=t.clientY;tt0=Date.now();},{passive:true});
  gest.addEventListener('touchend',e=>{
    const t=e.changedTouches[0],dx=t.clientX-tx0,dy=t.clientY-ty0,dt=Date.now()-tt0,now=Date.now();
    if((now-lastTap)<DT&&Math.abs(dx)<28&&Math.abs(dy)<28){
      if(t.clientX<window.innerWidth/2){skip(-10);showSkip('L');}else{skip(10);showSkip('R');}
      lastTap=0;return;
    }
    if(Math.abs(dy)>SW&&Math.abs(dy)>Math.abs(dx)*1.4){changeEp(dy<0?1:-1);lastTap=now;return;}
    if(Math.abs(dx)<18&&Math.abs(dy)<18&&dt<300){
      if(drawer.classList.contains('on'))closeDr();
      else if(ctrlVis)hideCtrl();else showCtrl();
    }
    lastTap=now;
  },{passive:true});

  /* PROGRESS */
  function applyP(cx,seek){
    const r=pWrap.getBoundingClientRect(),pos=Math.max(0,Math.min(1,(cx-r.left)/r.width));
    pFill.style.width=(pos*100)+'%';pHnd.style.left=(pos*100)+'%';
    if(seek&&video.duration)video.currentTime=pos*video.duration;
    else if(video.duration)curT.textContent=fmt(pos*video.duration);
  }
  pWrap.addEventListener('touchstart',e=>{isDrag=true;applyP(e.touches[0].clientX,false);e.stopPropagation();e.preventDefault();},{passive:false});
  document.addEventListener('touchmove',e=>{if(isDrag){applyP(e.touches[0].clientX,false);e.preventDefault();}},{passive:false});
  document.addEventListener('touchend',e=>{if(isDrag){isDrag=false;applyP(e.changedTouches[0].clientX,true);}});
  pWrap.addEventListener('mousedown',e=>{isDrag=true;applyP(e.clientX,false);e.preventDefault();});
  document.addEventListener('mousemove',e=>{if(isDrag)applyP(e.clientX,false);});
  document.addEventListener('mouseup',e=>{if(isDrag){isDrag=false;applyP(e.clientX,true);}});

  /* VIDEO EVENTS */
  video.addEventListener('timeupdate',()=>{
    if(isDrag||!video.duration)return;
    const p=video.currentTime/video.duration;
    pFill.style.width=(p*100)+'%';pHnd.style.left=(p*100)+'%';
    curT.textContent=fmt(video.currentTime);
    hist[sid+'_'+curEp]={t:Math.round(video.currentTime),d:Math.round(video.duration)};
    try{localStorage.setItem(H_KEY,JSON.stringify(hist));}catch{}
  });
  video.addEventListener('loadedmetadata',()=>{durT.textContent=fmt(video.duration);});
  video.addEventListener('play',()=>{setPP(true);flashCI('play');resetHT();spin.classList.remove('on');bufLbl.classList.remove('on');});
  video.addEventListener('pause',()=>{setPP(false);flashCI('pause');showCtrl();clearTimeout(hideTimer);});
  video.addEventListener('waiting',()=>{if(!isLoading){spin.classList.add('on');bufLbl.classList.add('on');}});
  video.addEventListener('canplay',()=>{spin.classList.remove('on');bufLbl.classList.remove('on');});
  video.addEventListener('playing',()=>{spin.classList.remove('on');bufLbl.classList.remove('on');errBox.classList.remove('on');});

  /* ‚òÖ ERROR: ignore if isLoading (reset phase) ‚òÖ */
  video.addEventListener('error',()=>{
    if(isLoading)return;
    spin.classList.remove('on');
    errBox.classList.add('on');
  });

  video.addEventListener('ended',()=>{
    showCtrl();
    if(curEp<show.episodes.length-1){
      const nx=show.episodes[curEp+1];
      nTit.textContent='Ep '+nx.ep+': '+nx.title;
      nextOv.classList.add('on');
      nextTimer=setTimeout(()=>{
        if(nx.is_free){curEp++;loadEpisode(curEp,1);}
        else{toastMsg('üîí ‡§Ö‡§ó‡§≤‡§æ GOLD ‡§π‡•à');hideNextOv();}
      },5000);
    }
  });

  document.getElementById('retry').addEventListener('click',()=>{errBox.classList.remove('on');loadEpisode(curEp,0);});

  function hideNextOv(){nextOv.classList.remove('on');clrNext();}
  function clrNext(){clearTimeout(nextTimer);nextTimer=null;}
  document.getElementById('n-cancel').addEventListener('click',hideNextOv);
  document.getElementById('n-go').addEventListener('click',()=>{
    clrNext();
    if(curEp<show.episodes.length-1){
      const nx=show.episodes[curEp+1];
      if(!nx.is_free){toastMsg('üîí GOLD ‡§ö‡§æ‡§π‡§ø‡§è');hideNextOv();return;}
      curEp++;loadEpisode(curEp,1);
    }
  });

  document.getElementById('back-btn').addEventListener('click',()=>{
    video.pause();if(blobUrl){URL.revokeObjectURL(blobUrl);blobUrl=null;}history.back();
  });

  /* KEYBOARD */
  document.addEventListener('keydown',e=>{
    if(e.target.tagName==='INPUT')return;
    if(e.key===' '||e.key==='k'){e.preventDefault();togglePlay();}
    else if(e.key==='ArrowRight'||e.key==='l'){skip(10);showSkip('R');}
    else if(e.key==='ArrowLeft'||e.key==='j'){skip(-10);showSkip('L');}
    else if(e.key==='ArrowDown')changeEp(1);
    else if(e.key==='ArrowUp')changeEp(-1);
    else if(e.key==='m')document.getElementById('vol-btn').click();
    showCtrl();
  });

  window.addEventListener('popstate',e=>{if(e.state?.ep!=null)loadEpisode(e.state.ep,0);});
  document.addEventListener('visibilitychange',()=>{if(document.hidden)video.pause();});

  loadData();
})();
</script>
</body>
</html>
