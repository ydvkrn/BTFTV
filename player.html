<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>BTF TV ‚Äì Player</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Font Awesome 6 (free) for all icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- SECURITY: Prevent any right-click, selection, drag -->
<style>
*{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;}
</style>
</head>
<body>

<style>
:root{--g:#FFD700;--gd:#C9A800;--bk:#000;--b2:#0d0d0d;--b3:#1a1a1a;--b4:#222;--wh:#fff;--gr:#777;--rd:#E8000A;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'Poppins',sans-serif;background:var(--bk);color:var(--wh);max-width:480px;margin:0 auto;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;}

/* LOADING SCREEN */
#ld{position:fixed;inset:0;background:var(--bk);z-index:200;display:flex;align-items:center;justify-content:center;transition:opacity .4s;}
#ld.off{opacity:0;pointer-events:none;}
.ld-logo{font-family:'Bebas Neue',cursive;font-size:2.8rem;color:var(--g);letter-spacing:3px;text-align:center;}
.ld-logo span{color:var(--rd);}
.ld-bar{width:100px;height:2px;background:var(--b4);border-radius:2px;margin:10px auto 0;overflow:hidden;}
.ld-f{height:100%;background:var(--g);animation:lf 1.2s ease forwards;}
@keyframes lf{from{width:0}to{width:100%}}

/* TOP BAR */
.tbar{display:flex;align-items:center;gap:12px;padding:13px 16px;background:var(--bk);border-bottom:1px solid #1a1a1a;}
.bk{background:var(--b3);border:none;color:var(--wh);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;flex-shrink:0;}
.bk:active{background:var(--g);color:var(--bk);}
.bar-t{font-family:'Bebas Neue',cursive;font-size:1.2rem;letter-spacing:1px;color:var(--wh);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bar-id{margin-left:auto;font-size:.65rem;color:var(--b4);font-family:'Poppins',sans-serif;}

/* ‚ïê‚ïê‚ïê VIDEO WRAPPER ‚ïê‚ïê‚ïê */
#vid-wrap{
  position:relative;
  width:100%;
  padding-top:56.25%;
  background:#000;
  overflow:hidden;
  -webkit-touch-callout:none;
}
#vid-wrap.fullscreen{
  position:fixed;top:0;left:0;width:100%;height:100%;padding-top:0;z-index:1000;
  display:flex;align-items:center;justify-content:center;background:#000;
}
#vid-wrap.fullscreen video{
  width:100%;height:100%;object-fit:contain;
}

/* INVISIBLE OVERLAY */
#vid-block{position:absolute;inset:0;z-index:10;background:transparent;pointer-events:none;}
#vid{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000;display:block;pointer-events:none;}
video::-webkit-media-controls{display:none!important;}
video::-webkit-media-controls-enclosure{display:none!important;}
video::-webkit-media-controls-panel{display:none!important;}
video::--webkit-media-controls{display:none!important;}
video::-moz-range-thumb{display:none!important;}

/* BUFFER BAR */
#buf{position:absolute;bottom:52px;left:0;right:0;height:2px;background:rgba(255,255,255,.1);z-index:12;}
#buf-fill{height:100%;background:rgba(255,255,255,.2);width:0;transition:width .3s;}

/* CUSTOM PROGRESS */
#prog-wrap{position:absolute;bottom:42px;left:0;right:0;z-index:12;padding:6px 0;cursor:pointer;}
#prog-track{width:100%;height:3px;background:rgba(255,255,255,.15);position:relative;transition:height .2s;}
#prog-wrap:hover #prog-track{height:5px;}
#prog-fill{height:100%;background:var(--g);width:0%;border-radius:2px;pointer-events:none;transition:width .05s linear;}
#prog-thumb{width:14px;height:14px;background:var(--g);border-radius:50%;position:absolute;top:50%;transform:translate(-50%,-50%);left:0%;display:none;box-shadow:0 0 6px rgba(255,215,0,.5);}
#prog-wrap:hover #prog-thumb{display:block;}
#prog-time{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:var(--wh);font-size:.65rem;padding:2px 8px;border-radius:4px;white-space:nowrap;opacity:0;transition:opacity .2s;pointer-events:none;margin-bottom:6px;}
#prog-wrap:hover #prog-time{opacity:1;}

/* MAIN CONTROLS */
#ctrl{
  position:absolute;bottom:0;left:0;right:0;
  background:linear-gradient(to top,rgba(0,0,0,.9) 0%,transparent 100%);
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 14px 10px;z-index:15;
  height:48px; /* slightly taller */
}
.ctrl-time{font-size:.75rem;color:rgba(255,255,255,.9);font-weight:600;letter-spacing:.3px;}
.ctrl-btn{
  background:none;border:none;color:var(--wh);font-size:1.4rem;cursor:pointer;padding:0 8px;
  display:flex;align-items:center;justify-content:center;transition:color .2s;min-width:44px;
}
.ctrl-btn:active{color:var(--g);}
.ctrl-btn:disabled{opacity:.2;cursor:not-allowed;}

/* SKIP BUTTONS (10s) */
.skip-btn{
  position:absolute;top:50%;transform:translateY(-50%);z-index:14;
  background:rgba(0,0,0,.35);border:none;color:var(--wh);
  width:56px;height:56px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;gap:2px;
  opacity:0;transition:opacity .2s;backdrop-filter:blur(4px);
}
.skip-btn span{font-size:.5rem;font-weight:700;color:rgba(255,255,255,.8);}
#skip-b{left:calc(50% - 90px);}
#skip-f{right:calc(50% - 90px);}
#vid-wrap.ctrl-vis .skip-btn{opacity:1;}
.skip-ico{font-size:1.4rem;}

/* PLAY/PAUSE CENTER BTN */
#play-btn{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:14;
  width:64px;height:64px;background:rgba(255,215,0,.9);border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1.8rem;box-shadow:0 0 20px rgba(255,215,0,.35);
  opacity:0;transition:opacity .2s;backdrop-filter:blur(4px);
}
#vid-wrap.ctrl-vis #play-btn{opacity:1;}

/* DOUBLE TAP FLASH */
.dt-flash{
  position:absolute;top:0;bottom:0;width:45%;background:rgba(255,215,0,.12);border-radius:4px;
  opacity:0;z-index:16;pointer-events:none;transition:opacity .15s;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:1rem;color:var(--g);letter-spacing:.5px;
}
#dt-left{left:0;border-radius:0 50% 50% 0;}
#dt-right{right:0;border-radius:50% 0 0 50%;}
.dt-flash.on{opacity:1;}

/* UP NEXT OVERLAY (appears when video ends) */
#up-next{
  position:absolute;inset:0;z-index:20;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);
  display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;
  opacity:0;transition:opacity .3s;
}
#up-next.show{display:flex;opacity:1;}
.up-title{font-family:'Bebas Neue',cursive;font-size:1.8rem;color:var(--g);}
.up-ep{font-size:1.1rem;color:var(--wh);margin-bottom:8px;}
.up-actions{display:flex;gap:30px;}
.up-btn{background:var(--b3);border:none;color:var(--wh);font-size:1.2rem;padding:12px 25px;border-radius:40px;cursor:pointer;font-weight:600;border:1px solid var(--b4);}
.up-btn:active{background:var(--g);color:var(--bk);}
.up-btn i{margin-right:8px;}

/* SPINNER */
#spinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:13;display:none;}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg);}}
#spinner.on{display:block;animation:spin .8s linear infinite;}
.spin-ring{width:44px;height:44px;border:3px solid rgba(255,255,255,.1);border-top-color:var(--g);border-radius:50%;}

/* INFO SECTION */
.info-sec{padding:14px 16px 8px;}
.sh-name{font-size:.75rem;color:var(--g);font-weight:600;margin-bottom:4px;}
.ep-title{font-family:'Bebas Neue',cursive;font-size:1.7rem;color:var(--wh);letter-spacing:.5px;line-height:1.1;}
.ep-meta{font-size:.72rem;color:var(--gr);margin-top:5px;}
.ep-desc{font-size:.8rem;color:#999;line-height:1.55;margin-top:10px;}

/* EPISODE LIST NEXT */
.nxt-sec{padding:4px 16px 16px;}
.nxt-title{font-family:'Bebas Neue',cursive;font-size:1.1rem;letter-spacing:.8px;color:var(--wh);margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.nxt-title::before{content:'';display:inline-block;width:3px;height:16px;background:var(--rd);border-radius:2px;}
.nepc{display:flex;align-items:center;gap:12px;padding:11px 12px;background:var(--b2);border-radius:12px;margin-bottom:7px;cursor:pointer;border:1px solid transparent;transition:border-color .15s;}
.nepc:active{background:var(--b3);border-color:var(--gd);}
.nepc.locked{opacity:.65;}
.ne-num{font-family:'Bebas Neue',cursive;font-size:1.4rem;color:var(--g);min-width:26px;text-align:center;line-height:1;}
.ne-th{width:65px;height:65px;border-radius:8px;overflow:hidden;flex-shrink:0;position:relative;display:flex;align-items:center;justify-content:center;font-size:1.5rem;}
.ne-th img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.ne-inf{flex:1;min-width:0;}
.ne-tit{font-size:.8rem;font-weight:600;color:var(--wh);}
.ne-meta{font-size:.66rem;color:var(--gr);margin-top:3px;}
.ne-lock{margin-left:auto;font-size:.9rem;color:var(--g);}

/* TOAST */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--b3);color:var(--wh);border:1px solid var(--b4);padding:10px 20px;border-radius:30px;font-size:.8rem;font-weight:600;z-index:999;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0);}
.sp{height:30px;}
</style>

<!-- LOADING -->
<div id="ld"><div><div class="ld-logo" id="ld-logo">BTF<span>TV</span></div><div class="ld-bar"><div class="ld-f"></div></div></div></div>

<!-- TOAST -->
<div id="toast"></div>

<!-- TOP BAR -->
<div class="tbar">
  <button class="bk" id="back-btn"><i class="fas fa-arrow-left"></i></button>
  <div class="bar-t" id="bar-t">Loading...</div>
  <div class="bar-id" id="bar-id"></div>
</div>

<!-- VIDEO WRAP -->
<div id="vid-wrap">
  <!-- Security overlay: blocks all right-click, save, etc. -->
  <div id="vid-block"></div>

  <!-- Double tap flash indicators -->
  <div class="dt-flash" id="dt-left"><i class="fas fa-backward"></i> 10s</div>
  <div class="dt-flash" id="dt-right">10s <i class="fas fa-forward"></i></div>

  <!-- Spinner -->
  <div id="spinner"><div class="spin-ring"></div></div>

  <!-- Actual Video element -->
  <video id="vid"
    playsinline
    preload="metadata"
    disablepictureinpicture
    controlslist="nodownload nofullscreen noremoteplayback"
    x-webkit-airplay="deny"
  ></video>

  <!-- Buffer bar -->
  <div id="buf"><div id="buf-fill"></div></div>

  <!-- Progress -->
  <div id="prog-wrap" id="prog">
    <div id="prog-track">
      <div id="prog-fill"></div>
      <div id="prog-thumb"></div>
    </div>
    <div id="prog-time">0:00</div>
  </div>

  <!-- Skip buttons (10s) -->
  <button class="skip-btn" id="skip-b" onclick="skip(-10)">
    <i class="fas fa-undo-alt skip-ico"></i><span>10s</span>
  </button>
  <button class="skip-btn" id="skip-f" onclick="skip(10)">
    <i class="fas fa-redo-alt skip-ico"></i><span>10s</span>
  </button>

  <!-- Play / Pause center -->
  <button id="play-btn" onclick="togglePlay()"><i class="fas fa-play"></i></button>

  <!-- Up Next Overlay -->
  <div id="up-next">
    <div class="up-title">‡§Ö‡§ó‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§°</div>
    <div class="up-ep" id="up-ep-title">Ep 2: Title</div>
    <div class="up-actions">
      <button class="up-btn" id="up-cancel"><i class="fas fa-times"></i> ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
      <button class="up-btn" id="up-go"><i class="fas fa-step-forward"></i> ‡§Ö‡§≠‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç</button>
    </div>
  </div>

  <!-- Controls bar -->
  <div id="ctrl">
    <span class="ctrl-time" id="t-cur">0:00</span>
    <button class="ctrl-btn" id="ep-prev" onclick="prevEp()"><i class="fas fa-step-backward"></i></button>
    <button class="ctrl-btn" id="ep-next" onclick="nextEp()"><i class="fas fa-step-forward"></i></button>
    <span class="ctrl-time" id="t-dur">--:--</span>
    <button class="ctrl-btn" id="fullscreen-btn" onclick="toggleFullscreen()"><i class="fas fa-expand"></i></button>
  </div>
</div>

<!-- INFO -->
<div class="info-sec">
  <div class="sh-name" id="sh-name"></div>
  <div class="ep-title" id="ep-title"></div>
  <div class="ep-meta" id="ep-meta"></div>
  <div class="ep-desc" id="ep-desc"></div>
</div>

<!-- NEXT EPISODES -->
<div class="nxt-sec">
  <div class="nxt-title">‡§Ö‡§ó‡§≤‡•á Episodes</div>
  <div id="nxt-list"></div>
</div>

<div class="sp"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
'use strict';

// ‚îÄ‚îÄ SECURITY LAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('contextmenu',e=>e.preventDefault(),true);
document.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if((e.ctrlKey||e.metaKey)&&['s','u','a','c','j','i','p'].includes(k)){e.preventDefault();e.stopPropagation();}
  if(e.key==='F12'||e.key==='PrintScreen'){e.preventDefault();}
},true);
document.addEventListener('dragstart',e=>e.preventDefault(),true);
document.addEventListener('drop',e=>e.preventDefault(),true);
document.addEventListener('selectstart',e=>e.preventDefault(),true);
document.addEventListener('touchstart',e=>{if(e.target.tagName==='VIDEO')e.preventDefault();},{passive:false});

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let D=null, show=null, epIdx=0, ctrlTimer=null, isDragging=false, blobUrl=null;
const params=new URLSearchParams(location.search);
const sid=params.get('sid');
epIdx=parseInt(params.get('ei')||'0',10);
const history_=JSON.parse(localStorage.getItem('btftv_h')||'{}');

// ‚îÄ‚îÄ ELEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const vid=document.getElementById('vid');
const vidWrap=document.getElementById('vid-wrap');
const playBtn=document.getElementById('play-btn');
const progFill=document.getElementById('prog-fill');
const progThumb=document.getElementById('prog-thumb');
const progTime=document.getElementById('prog-time');
const bufFill=document.getElementById('buf-fill');
const tCur=document.getElementById('t-cur');
const tDur=document.getElementById('t-dur');
const spinner=document.getElementById('spinner');
const dtLeft=document.getElementById('dt-left');
const dtRight=document.getElementById('dt-right');
const upNext=document.getElementById('up-next');
const upEpTitle=document.getElementById('up-ep-title');

// ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function load(){
  try{const r=await fetch('https://storytv.btfcompanystorage.workers.dev/data');if(!r.ok)throw 0;D=await r.json();}
  catch{showError('data.json load failed');return;}
  show=D.shows.find(s=>s.id===sid);
  if(!show){showError('Show not found');return;}
  setFavicon();
  setupSecurity();
  loadEpisode(epIdx);
  setTimeout(()=>{document.getElementById('ld').classList.add('off');},800);
}

function setFavicon(){
  if(!D.site.favicon_url)return;
  let l=document.querySelector("link[rel='icon']")||document.createElement('link');
  l.rel='icon';l.href=D.site.favicon_url;document.head.appendChild(l);
}

// ‚îÄ‚îÄ LOAD EPISODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadEpisode(idx){
  const ep=show.episodes[idx];
  if(!ep)return;
  epIdx=idx;

  const newUrl=location.pathname+'?sid='+sid+'&ei='+idx;
  history.replaceState(null,'',newUrl);

  if(blobUrl){URL.revokeObjectURL(blobUrl);blobUrl=null;}

  document.getElementById('bar-t').textContent='Ep '+ep.ep+' ¬∑ '+ep.title;
  document.getElementById('bar-id').textContent='';
  document.getElementById('sh-name').textContent=show.title+' ¬∑ '+show.genre;
  document.getElementById('ep-title').textContent=ep.title;
  document.getElementById('ep-meta').textContent=
    'Episode '+ep.ep+'  ¬∑  '+ep.duration+'  ¬∑  '+show.language+' ¬∑ '+show.year;
  document.getElementById('ep-desc').textContent=ep.description;
  document.title='Ep '+ep.ep+' ‚Äì '+show.title+' | '+D.site.name;

  document.getElementById('ep-prev').disabled=idx===0;
  document.getElementById('ep-next').disabled=idx===show.episodes.length-1;

  loadVideoSecure(ep.video_url);
  renderNext(idx);

  const key=sid+'_'+idx;
  const savedTime=history_[key]?.t||0;
  if(savedTime>3){
    vid.addEventListener('canplay',function once(){
      vid.currentTime=savedTime;
      vid.removeEventListener('canplay',once);
    });
  }

  // Update play button icon (reset)
  playBtn.innerHTML=vid.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
  // Hide up-next if visible
  upNext.classList.remove('show');
}

// ‚îÄ‚îÄ SECURE VIDEO LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadVideoSecure(url){
  spinner.classList.add('on');
  vid.src='';
  try{
    const resp=await fetch(url,{mode:'cors'});
    if(!resp.ok)throw new Error('fetch failed');
    const blob=await resp.blob();
    blobUrl=URL.createObjectURL(blob);
    vid.src=blobUrl;
    vid.load();
  } catch(e){
    toast('‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü, ‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...');
    vid.src=url;
    vid.load();
  } finally{
    spinner.classList.remove('on');
  }
}

// ‚îÄ‚îÄ PLAYBACK CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePlay(){
  if(vid.paused){
    vid.play().catch(()=>{});
    playBtn.innerHTML='<i class="fas fa-pause"></i>';
  }else{
    vid.pause();
    playBtn.innerHTML='<i class="fas fa-play"></i>';
  }
  showCtrl();
}

function skip(sec){
  vid.currentTime=Math.max(0,Math.min(vid.duration||0,vid.currentTime+sec));
  flashSkip(sec<0?'left':'right');
  showCtrl();
}

function prevEp(){
  if(epIdx>0)loadEpisode(epIdx-1);
}
function nextEp(){
  if(epIdx<show.episodes.length-1){
    const next=show.episodes[epIdx+1];
    if(!next.is_free){toast('üîí GOLD subscribers ke liye');return;}
    loadEpisode(epIdx+1);
  }
}

// ‚îÄ‚îÄ FULLSCREEN TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFullscreen(){
  if(!document.fullscreenElement){
    vidWrap.requestFullscreen().catch(err=>toast('Fullscreen ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü'));
  }else{
    document.exitFullscreen();
  }
}
document.addEventListener('fullscreenchange',()=>{
  const fsBtn=document.getElementById('fullscreen-btn').querySelector('i');
  if(document.fullscreenElement){
    vidWrap.classList.add('fullscreen');
    fsBtn.className='fas fa-compress';
  }else{
    vidWrap.classList.remove('fullscreen');
    fsBtn.className='fas fa-expand';
  }
});

// ‚îÄ‚îÄ CONTROLS VISIBILITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showCtrl(){
  vidWrap.classList.add('ctrl-vis');
  clearTimeout(ctrlTimer);
  if(!vid.paused){ctrlTimer=setTimeout(()=>vidWrap.classList.remove('ctrl-vis'),3000);}
}

vidWrap.addEventListener('click',(e)=>{
  if(e.target.closest('button')||e.target===progWrap) return; // ignore buttons
  if(vidWrap.classList.contains('ctrl-vis')){
    if(!vid.paused){vidWrap.classList.remove('ctrl-vis');}
  } else {
    showCtrl();
  }
});

// ‚îÄ‚îÄ VIDEO EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
vid.addEventListener('play',()=>{playBtn.innerHTML='<i class="fas fa-pause"></i>';showCtrl();});
vid.addEventListener('pause',()=>{playBtn.innerHTML='<i class="fas fa-play"></i>';showCtrl();});
vid.addEventListener('waiting',()=>spinner.classList.add('on'));
vid.addEventListener('canplay',()=>spinner.classList.remove('on'));
vid.addEventListener('loadedmetadata',()=>{
  tDur.textContent=fmt(vid.duration);
});
vid.addEventListener('timeupdate',()=>{
  if(!isDragging&&!isNaN(vid.duration)){
    const pct=(vid.currentTime/vid.duration)*100;
    progFill.style.width=pct+'%';
    progThumb.style.left=pct+'%';
    tCur.textContent=fmt(vid.currentTime);
    saveProgress();
  }
  if(vid.buffered.length>0){
    const bpct=(vid.buffered.end(vid.buffered.length-1)/vid.duration)*100;
    bufFill.style.width=bpct+'%';
  }
});
vid.addEventListener('ended',()=>{
  playBtn.innerHTML='<i class="fas fa-play"></i>';
  vidWrap.classList.add('ctrl-vis');
  // Show up-next if there is a next episode (free or not, but we'll check)
  if(epIdx<show.episodes.length-1){
    const next=show.episodes[epIdx+1];
    upEpTitle.textContent = `Ep ${next.ep}: ${next.title}`;
    upNext.classList.add('show');
    // Auto-go after 10 seconds (cancelable)
    upNext.dataset.timeout = setTimeout(()=>{
      if(upNext.classList.contains('show')){
        if(next.is_free) loadEpisode(epIdx+1);
        else { toast('üîí ‡§Ö‡§ó‡§≤‡§æ ‡§è‡§™‡§ø‡§∏‡•ã‡§° GOLD ‡§π‡•à'); upNext.classList.remove('show'); }
      }
    },10000);
  }
});
document.getElementById('up-cancel').addEventListener('click',()=>{
  clearTimeout(upNext.dataset.timeout);
  upNext.classList.remove('show');
});
document.getElementById('up-go').addEventListener('click',()=>{
  clearTimeout(upNext.dataset.timeout);
  if(epIdx<show.episodes.length-1){
    const next=show.episodes[epIdx+1];
    if(!next.is_free){toast('üîí GOLD required'); upNext.classList.remove('show'); return;}
    loadEpisode(epIdx+1);
  }
});

// ‚îÄ‚îÄ PROGRESS BAR DRAG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const progWrap=document.getElementById('prog-wrap');
function setProg(clientX){
  const rect=progWrap.getBoundingClientRect();
  const pct=Math.max(0,Math.min(1,(clientX-rect.left)/rect.width));
  const newTime=pct*vid.duration;
  progFill.style.width=(pct*100)+'%';
  progThumb.style.left=(pct*100)+'%';
  tCur.textContent=fmt(newTime);
  progTime.textContent=fmt(newTime);
  return newTime;
}
progWrap.addEventListener('mousedown',e=>{
  isDragging=true;
  setProg(e.clientX);
  e.preventDefault();
});
document.addEventListener('mousemove',e=>{if(isDragging){setProg(e.clientX);}});
document.addEventListener('mouseup',e=>{
  if(isDragging){vid.currentTime=setProg(e.clientX);isDragging=false;}
});
progWrap.addEventListener('touchstart',e=>{
  isDragging=true;setProg(e.touches[0].clientX);e.preventDefault();
},{passive:false});
document.addEventListener('touchmove',e=>{if(isDragging)setProg(e.touches[0].clientX);},{passive:true});
document.addEventListener('touchend',e=>{
  if(isDragging){vid.currentTime=setProg(e.changedTouches[0].clientX);isDragging=false;}
});
progWrap.addEventListener('mousemove',e=>{
  const rect=progWrap.getBoundingClientRect();
  const pct=(e.clientX-rect.left)/rect.width;
  progTime.textContent=fmt(pct*vid.duration);
  progTime.style.left=(pct*100)+'%';
});

// ‚îÄ‚îÄ DOUBLE TAP TO SKIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tapTimer=null, lastTap=0;
vidWrap.addEventListener('touchend',e=>{
  if(e.target.closest('button')||e.target===progWrap)return;
  const now=Date.now();
  const rect=vidWrap.getBoundingClientRect();
  const tx=e.changedTouches[0].clientX;
  const isLeft=tx<rect.left+rect.width/2;
  if(now-lastTap<300){
    clearTimeout(tapTimer);
    skip(isLeft?-10:10);
  } else {
    tapTimer=setTimeout(()=>{showCtrl();},300);
  }
  lastTap=now;
});

function flashSkip(side){
  const el=side==='left'?dtLeft:dtRight;
  el.classList.add('on');
  setTimeout(()=>el.classList.remove('on'),500);
}

// ‚îÄ‚îÄ SAVE PROGRESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveProgress(){
  const key=sid+'_'+epIdx;
  history_[key]={sid,ei:epIdx,t:Math.round(vid.currentTime),d:Math.round(vid.duration)||9999};
  try{localStorage.setItem('btftv_h',JSON.stringify(history_));}catch(e){}
}

// ‚îÄ‚îÄ RENDER NEXT EPISODES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderNext(curIdx){
  const list=document.getElementById('nxt-list');
  const nexts=show.episodes.filter((_,i)=>i!==curIdx).slice(curIdx,curIdx+5);
  if(!nexts.length){list.innerHTML='<p style="color:var(--gr);font-size:.8rem">‡§ï‡•ã‡§à ‡§Ö‡§ó‡§≤‡§æ episode ‡§®‡§π‡•Ä‡§Ç‡•§</p>';return;}
  list.innerHTML=nexts.map((ep,i)=>{
    const ni=curIdx+1+i;
    const lockedClass = ep.is_free ? '' : 'locked';
    const lockIcon = ep.is_free ? '' : '<i class="fas fa-lock ne-lock"></i>';
    return`<div class="nepc ${lockedClass}" onclick="nxtEpCk(${ni})">
      <div class="ne-num">${ep.ep}</div>
      <div class="ne-th" style="background:${show.gradient}">
        ${ep.thumbnail_url ? `<img src="${ep.thumbnail_url}" alt="" onerror="this.style.display='none'">` : ''}
        <i class="fas fa-film" style="font-size:2rem; color:rgba(255,255,255,0.7);"></i>
      </div>
      <div class="ne-inf">
        <div class="ne-tit">${ep.title}</div>
        <div class="ne-meta">‚è± ${ep.duration}${ep.is_free ? ' ¬∑ <i class="fas fa-lock-open" style="color:var(--g);"></i> FREE' : ''}</div>
      </div>
      ${lockIcon}
    </div>`;
  }).join('');
}

function nxtEpCk(i){
  const ep=show.episodes[i];
  if(!ep)return;
  if(!ep.is_free){toast('üîí Yeh episode GOLD subscribers ke liye hai');return;}
  loadEpisode(i);
  window.scrollTo({top:0,behavior:'smooth'});
}

// ‚îÄ‚îÄ SECURITY: Block overlay pointer events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupSecurity(){
  const block=document.getElementById('vid-block');
  block.style.pointerEvents='all';
  block.addEventListener('contextmenu',e=>e.preventDefault(),true);
  block.addEventListener('touchstart',e=>e.preventDefault(),{passive:false});
  block.style.cursor='default';
}

// Back button
document.getElementById('back-btn').onclick=()=>{
  vid.pause();
  if(blobUrl){URL.revokeObjectURL(blobUrl);blobUrl=null;}
  history.back();
};

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(s){
  if(!s||isNaN(s))return'0:00';
  const m=Math.floor(s/60),sec=Math.floor(s%60);
  return m+':'+(sec<10?'0':'')+sec;
}
function toast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');
  setTimeout(()=>t.classList.remove('on'),2500);
}
function showError(msg){
  document.getElementById('ld').innerHTML='<p style="color:#fff;padding:20px;font-family:sans-serif">‚ö†Ô∏è '+msg+'</p>';
}

// Prevent PiP
document.addEventListener('enterpictureinpicture',e=>e.preventDefault(),true);

// ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
load();
</script>
</body>
</html>
